"use strict";(()=>{var yl=Object.create;var gs=Object.defineProperty;var vl=Object.getOwnPropertyDescriptor;var wl=Object.getOwnPropertyNames;var bl=Object.getPrototypeOf,xl=Object.prototype.hasOwnProperty;var kl=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports);var Sl=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of wl(e))!xl.call(n,i)&&i!==t&&gs(n,i,{get:()=>e[i],enumerable:!(r=vl(e,i))||r.enumerable});return n};var Al=(n,e,t)=>(t=n!=null?yl(bl(n)):{},Sl(e||!n||!n.__esModule?gs(t,"default",{value:n,enumerable:!0}):t,n));var Ks=kl((Wo,Oo)=>{(function(n,e){typeof define=="function"&&define.amd?define([],e):typeof Wo<"u"?e():(e(),n.FileSaver={})})(Wo,function(){"use strict";function n(f,p){return typeof p>"u"?p={autoBom:!1}:typeof p!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),p={autoBom:!p}),p.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(f.type)?new Blob(["\uFEFF",f],{type:f.type}):f}function e(f,p,_){var y=new XMLHttpRequest;y.open("GET",f),y.responseType="blob",y.onload=function(){u(y.response,p,_)},y.onerror=function(){console.error("could not download file")},y.send()}function t(f){var p=new XMLHttpRequest;p.open("HEAD",f,!1);try{p.send()}catch{}return 200<=p.status&&299>=p.status}function r(f){try{f.dispatchEvent(new MouseEvent("click"))}catch{var p=document.createEvent("MouseEvents");p.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),f.dispatchEvent(p)}}var i=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof global=="object"&&global.global===global?global:void 0,s=i.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),u=i.saveAs||(typeof window!="object"||window!==i?function(){}:"download"in HTMLAnchorElement.prototype&&!s?function(f,p,_){var y=i.URL||i.webkitURL,m=document.createElement("a");p=p||f.name||"download",m.download=p,m.rel="noopener",typeof f=="string"?(m.href=f,m.origin===location.origin?r(m):t(m.href)?e(f,p,_):r(m,m.target="_blank")):(m.href=y.createObjectURL(f),setTimeout(function(){y.revokeObjectURL(m.href)},4e4),setTimeout(function(){r(m)},0))}:"msSaveOrOpenBlob"in navigator?function(f,p,_){if(p=p||f.name||"download",typeof f!="string")navigator.msSaveOrOpenBlob(n(f,_),p);else if(t(f))e(f,p,_);else{var y=document.createElement("a");y.href=f,y.target="_blank",setTimeout(function(){r(y)})}}:function(f,p,_,y){if(y=y||open("","_blank"),y&&(y.document.title=y.document.body.innerText="downloading..."),typeof f=="string")return e(f,p,_);var m=f.type==="application/octet-stream",b=/constructor/i.test(i.HTMLElement)||i.safari,x=/CriOS\/[\d]+/.test(navigator.userAgent);if((x||m&&b||s)&&typeof FileReader<"u"){var U=new FileReader;U.onloadend=function(){var I=U.result;I=x?I:I.replace(/^data:[^;]*;/,"data:attachment/file;"),y?y.location.href=I:location=I,y=null},U.readAsDataURL(f)}else{var E=i.URL||i.webkitURL,T=E.createObjectURL(f);y?y.location=T:location.href=T,y=null,setTimeout(function(){E.revokeObjectURL(T)},4e4)}});i.saveAs=u.saveAs=u,typeof Oo<"u"&&(Oo.exports=u)})});var Le=Uint8Array,er=Uint16Array,El=Int32Array,ys=new Le([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),vs=new Le([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Fl=new Le([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),ws=function(n,e){for(var t=new er(31),r=0;r<31;++r)t[r]=e+=1<<n[r-1];for(var i=new El(t[30]),r=1;r<30;++r)for(var s=t[r];s<t[r+1];++s)i[s]=s-t[r]<<5|r;return{b:t,r:i}},bs=ws(ys,2),xs=bs.b,Ul=bs.r;xs[28]=258,Ul[258]=28;var ks=ws(vs,0),Cl=ks.b,wc=ks.r,ko=new er(32768);for(te=0;te<32768;++te)lt=(te&43690)>>1|(te&21845)<<1,lt=(lt&52428)>>2|(lt&13107)<<2,lt=(lt&61680)>>4|(lt&3855)<<4,ko[te]=((lt&65280)>>8|(lt&255)<<8)>>1;var lt,te,Hr=function(n,e,t){for(var r=n.length,i=0,s=new er(e);i<r;++i)n[i]&&++s[n[i]-1];var u=new er(e);for(i=1;i<e;++i)u[i]=u[i-1]+s[i-1]<<1;var f;if(t){f=new er(1<<e);var p=15-e;for(i=0;i<r;++i)if(n[i])for(var _=i<<4|n[i],y=e-n[i],m=u[n[i]-1]++<<y,b=m|(1<<y)-1;m<=b;++m)f[ko[m]>>p]=_}else for(f=new er(r),i=0;i<r;++i)n[i]&&(f[i]=ko[u[n[i]-1]++]>>15-n[i]);return f},Jr=new Le(288);for(te=0;te<144;++te)Jr[te]=8;var te;for(te=144;te<256;++te)Jr[te]=9;var te;for(te=256;te<280;++te)Jr[te]=7;var te;for(te=280;te<288;++te)Jr[te]=8;var te,Ss=new Le(32);for(te=0;te<32;++te)Ss[te]=5;var te;var Rl=Hr(Jr,9,1);var Dl=Hr(Ss,5,1),bo=function(n){for(var e=n[0],t=1;t<n.length;++t)n[t]>e&&(e=n[t]);return e},Ze=function(n,e,t){var r=e/8|0;return(n[r]|n[r+1]<<8)>>(e&7)&t},xo=function(n,e){var t=e/8|0;return(n[t]|n[t+1]<<8|n[t+2]<<16)>>(e&7)},Bl=function(n){return(n+7)/8|0},Tl=function(n,e,t){return(e==null||e<0)&&(e=0),(t==null||t>n.length)&&(t=n.length),new Le(n.subarray(e,t))};var Il=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Ke=function(n,e,t){var r=new Error(e||Il[n]);if(r.code=n,Error.captureStackTrace&&Error.captureStackTrace(r,Ke),!t)throw r;return r},Wl=function(n,e,t,r){var i=n.length,s=r?r.length:0;if(!i||e.f&&!e.l)return t||new Le(0);var u=!t,f=u||e.i!=2,p=e.i;u&&(t=new Le(i*3));var _=function(Lt){var Nt=t.length;if(Lt>Nt){var Qt=new Le(Math.max(Nt*2,Lt));Qt.set(t),t=Qt}},y=e.f||0,m=e.p||0,b=e.b||0,x=e.l,U=e.d,E=e.m,T=e.n,I=i*8;do{if(!x){y=Ze(n,m,1);var j=Ze(n,m+1,3);if(m+=3,j)if(j==1)x=Rl,U=Dl,E=9,T=5;else if(j==2){var ee=Ze(n,m,31)+257,ie=Ze(n,m+10,15)+4,ge=ee+Ze(n,m+5,31)+1;m+=14;for(var oe=new Le(ge),be=new Le(19),le=0;le<ie;++le)be[Fl[le]]=Ze(n,m+le*3,7);m+=ie*3;for(var pe=bo(be),he=(1<<pe)-1,P=Hr(be,pe,1),le=0;le<ge;){var ce=P[Ze(n,m,he)];m+=ce&15;var ne=ce>>4;if(ne<16)oe[le++]=ne;else{var se=0,ue=0;for(ne==16?(ue=3+Ze(n,m,3),m+=2,se=oe[le-1]):ne==17?(ue=3+Ze(n,m,7),m+=3):ne==18&&(ue=11+Ze(n,m,127),m+=7);ue--;)oe[le++]=se}}var z=oe.subarray(0,ee),F=oe.subarray(ee);E=bo(z),T=bo(F),x=Hr(z,E,1),U=Hr(F,T,1)}else Ke(1);else{var ne=Bl(m)+4,ke=n[ne-4]|n[ne-3]<<8,me=ne+ke;if(me>i){p&&Ke(0);break}f&&_(b+ke),t.set(n.subarray(ne,me),b),e.b=b+=ke,e.p=m=me*8,e.f=y;continue}if(m>I){p&&Ke(0);break}}f&&_(b+131072);for(var C=(1<<E)-1,Z=(1<<T)-1,K=m;;K=m){var se=x[xo(n,m)&C],de=se>>4;if(m+=se&15,m>I){p&&Ke(0);break}if(se||Ke(2),de<256)t[b++]=de;else if(de==256){K=m,x=null;break}else{var Ee=de-254;if(de>264){var le=de-257,Me=ys[le];Ee=Ze(n,m,(1<<Me)-1)+xs[le],m+=Me}var dt=U[xo(n,m)&Z],Se=dt>>4;dt||Ke(3),m+=dt&15;var F=Cl[Se];if(Se>3){var Me=vs[Se];F+=xo(n,m)&(1<<Me)-1,m+=Me}if(m>I){p&&Ke(0);break}f&&_(b+131072);var Ce=b+Ee;if(b<F){var Re=s-F,De=Math.min(F,Ce);for(Re+b<0&&Ke(3);b<De;++b)t[b]=r[Re+b]}for(;b<Ce;++b)t[b]=t[b-F]}}e.l=x,e.p=K,e.b=b,e.f=y,x&&(y=1,e.m=E,e.d=U,e.n=T)}while(!y);return b!=t.length&&u?Tl(t,0,b):t.subarray(0,b)};var Ol=new Le(0);var Ml=function(n){(n[0]!=31||n[1]!=139||n[2]!=8)&&Ke(6,"invalid gzip data");var e=n[3],t=10;e&4&&(t+=(n[10]|n[11]<<8)+2);for(var r=(e>>3&1)+(e>>4&1);r>0;r-=!n[t++]);return t+(e&2)},Gl=function(n){var e=n.length;return(n[e-4]|n[e-3]<<8|n[e-2]<<16|n[e-1]<<24)>>>0};function tr(n,e){var t=Ml(n);return t+8>n.length&&Ke(6,"invalid gzip data"),Wl(n.subarray(t,-8),{i:2},e&&e.out||new Le(Gl(n)),e&&e.dictionary)}var Ll=typeof TextDecoder<"u"&&new TextDecoder,Nl=0;try{Ll.decode(Ol,{stream:!0}),Nl=1}catch{}var Ql=typeof global=="object"&&global&&global.Object===Object&&global,As=Ql;var Vl=typeof self=="object"&&self&&self.Object===Object&&self,jl=As||Vl||Function("return this")(),Xn=jl;var $l=Xn.Symbol,ft=$l;var Es=Object.prototype,Pl=Es.hasOwnProperty,zl=Es.toString,qr=ft?ft.toStringTag:void 0;function Hl(n){var e=Pl.call(n,qr),t=n[qr];try{n[qr]=void 0;var r=!0}catch{}var i=zl.call(n);return r&&(e?n[qr]=t:delete n[qr]),i}var Fs=Hl;var Jl=Object.prototype,ql=Jl.toString;function Yl(n){return ql.call(n)}var Us=Yl;var Zl="[object Null]",Kl="[object Undefined]",Cs=ft?ft.toStringTag:void 0;function Xl(n){return n==null?n===void 0?Kl:Zl:Cs&&Cs in Object(n)?Fs(n):Us(n)}var Rs=Xl;function ef(n){return n!=null&&typeof n=="object"}var Ds=ef;var tf="[object Symbol]";function rf(n){return typeof n=="symbol"||Ds(n)&&Rs(n)==tf}var ei=rf;function nf(n,e){for(var t=-1,r=n==null?0:n.length,i=Array(r);++t<r;)i[t]=e(n[t],t,n);return i}var Bs=nf;var of=Array.isArray,Ts=of;var sf=1/0,Is=ft?ft.prototype:void 0,Ws=Is?Is.toString:void 0;function Os(n){if(typeof n=="string")return n;if(Ts(n))return Bs(n,Os)+"";if(ei(n))return Ws?Ws.call(n):"";var e=n+"";return e=="0"&&1/n==-sf?"-0":e}var Ms=Os;var af=/\s/;function lf(n){for(var e=n.length;e--&&af.test(n.charAt(e)););return e}var Gs=lf;var ff=/^\s+/;function uf(n){return n&&n.slice(0,Gs(n)+1).replace(ff,"")}var Ls=uf;function cf(n){var e=typeof n;return n!=null&&(e=="object"||e=="function")}var Ut=cf;var Ns=NaN,df=/^[-+]0x[0-9a-f]+$/i,pf=/^0b[01]+$/i,hf=/^0o[0-7]+$/i,_f=parseInt;function mf(n){if(typeof n=="number")return n;if(ei(n))return Ns;if(Ut(n)){var e=typeof n.valueOf=="function"?n.valueOf():n;n=Ut(e)?e+"":e}if(typeof n!="string")return n===0?n:+n;n=Ls(n);var t=pf.test(n);return t||hf.test(n)?_f(n.slice(2),t?2:8):df.test(n)?Ns:+n}var So=mf;function gf(n){return n==null?"":Ms(n)}var Qs=gf;function yf(n){return function(e){return n?.[e]}}var Vs=yf;var vf=function(){return Xn.Date.now()},ti=vf;var wf="Expected a function",bf=Math.max,xf=Math.min;function kf(n,e,t){var r,i,s,u,f,p,_=0,y=!1,m=!1,b=!0;if(typeof n!="function")throw new TypeError(wf);e=So(e)||0,Ut(t)&&(y=!!t.leading,m="maxWait"in t,s=m?bf(So(t.maxWait)||0,e):s,b="trailing"in t?!!t.trailing:b);function x(ee){var ie=r,ge=i;return r=i=void 0,_=ee,u=n.apply(ge,ie),u}function U(ee){return _=ee,f=setTimeout(I,e),y?x(ee):u}function E(ee){var ie=ee-p,ge=ee-_,oe=e-ie;return m?xf(oe,s-ge):oe}function T(ee){var ie=ee-p,ge=ee-_;return p===void 0||ie>=e||ie<0||m&&ge>=s}function I(){var ee=ti();if(T(ee))return j(ee);f=setTimeout(I,E(ee))}function j(ee){return f=void 0,b&&r?x(ee):(r=i=void 0,u)}function ne(){f!==void 0&&clearTimeout(f),_=0,r=p=i=f=void 0}function ke(){return f===void 0?u:j(ti())}function me(){var ee=ti(),ie=T(ee);if(r=arguments,i=this,p=ee,ie){if(f===void 0)return U(p);if(m)return clearTimeout(f),f=setTimeout(I,e),x(p)}return f===void 0&&(f=setTimeout(I,e)),u}return me.cancel=ne,me.flush=ke,me}var Ct=kf;var Sf="Expected a function";function Af(n,e,t){var r=!0,i=!0;if(typeof n!="function")throw new TypeError(Sf);return Ut(t)&&(r="leading"in t?!!t.leading:r,i="trailing"in t?!!t.trailing:i),Ct(n,e,{leading:r,maxWait:e,trailing:i})}var ri=Af;var Ef={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"},Ff=Vs(Ef),js=Ff;var $s=/&(?:amp|lt|gt|quot|#39);/g,Uf=RegExp($s.source);function Cf(n){return n=Qs(n),n&&Uf.test(n)?n.replace($s,js):n}var Ao=Cf;var Ie=class extends DataView{constructor(e,t,r){e instanceof Uint8Array?super(e.buffer,e.byteOffset,e.byteLength):super(e,t,r)}getFourCC(e){return String.fromCharCode(this.getUint8(e),this.getUint8(e+1),this.getUint8(e+2),this.getUint8(e+3))}getUint8Subarray(e,t){return new Uint8Array(this.buffer,this.byteOffset+(e||0),t)}setFourCC(e,t){this.setUint8(e,t.charCodeAt(0)),this.setUint8(e+1,t.charCodeAt(1)),this.setUint8(e+2,t.charCodeAt(2)),this.setUint8(e+3,t.charCodeAt(3))}setUint8Array(e,t){this.getUint8Subarray(e,t.length).set(t)}};function gt(){return visualViewport?visualViewport.scale-1>.001:!1}var rr=new TextDecoder,Rf=new TextEncoder;var Yr=class{constructor(){this.type="";this.chunks=[]}parse(e){let t=new Ie(e);if(t.getFourCC(0)!=="FORM")throw new Error("Not an IFF file");this.type=t.getFourCC(8);let r=12,i=e.length;for(;r<i;){let s=t.getUint32(r+4);if(s<0||s+r>i)throw new Error("IFF chunk out of range");this.chunks.push({data:t.getUint8Subarray(r+8,s),offset:r,type:t.getFourCC(r)}),r+=8+s,r%2&&r++}}write(){let e=12;for(let i of this.chunks)e+=8+i.data.length,e%2&&e++;let t=new Ie(new ArrayBuffer(e));t.setFourCC(0,"FORM"),t.setUint32(4,e-8),t.setFourCC(8,this.type);let r=12;for(let i of this.chunks)t.setFourCC(r,i.type),t.setUint32(r+4,i.data.length),t.setUint8Array(r+8,i.data),r+=8+i.data.length,r%2&&r++;return t.getUint8Subarray()}};var Ps={Data:"data",Exec:"exec",Pict:"pict","Snd ":"sound"},zs="????",Zr=class{constructor(e){this.classname="Blorb";this.chunks={};this.is_inited=!1;this.metadata={};e&&this.init(e)}init(e,t){if(!this.is_inited){if(e instanceof Uint8Array){let r=new Yr;if(r.parse(e),r.type!=="IFRS")throw new Error("Not a Blorb file");if(r.chunks[0].type!=="RIdx")throw new Error("Malformed blorb: chunk 1 is not RIdx");for(let i of r.chunks)switch(i.type){case"Dbug":{this.debugdata=i.data;break}case"Fspc":{let s=new Ie(i.data);this.coverimagenum=s.getUint32(0);break}case"IFmd":{let s=rr.decode(i.data),u=/<bibliographic>(.+)<\/bibliographic>/is.exec(s),f=/<(\w+)>(.+)<\/\1>/gi,p=/<br\/>/g,_=/\s+/g;if(u){let y;for(;y=f.exec(u[1]);){let m=y[1].toLowerCase(),b=y[2].replace(_," ");m==="description"&&(b=b.replace(p,`
`)),this.metadata[m]=Ao(b)}}break}case"RDes":{let s=new Ie(i.data),u=4;for(;u<s.byteLength;){let f=Ps[s.getFourCC(u)],p=s.getUint32(u+4),_=s.getUint32(u+8),y=this.chunks[`${f}:${p}`];y&&(y.alttext=rr.decode(s.getUint8Subarray(u+12,_))),u+=12+_}break}case"RIdx":{let s=new Ie(i.data),u=4;for(;u<s.byteLength;){let f=s.getFourCC(u),p=s.getUint32(u+4),_=s.getUint32(u+8);u+=12;let y=r.chunks.filter(x=>x.offset===_)[0];if(!y)throw new Error(`No Blorb chunk at offset ${_}`);let m=y.type,b={blorbtype:m,content:m==="FORM"?e.subarray(y.offset,y.offset+8+y.data.length):y.data,usage:Ps[f]};f==="Pict"&&(m==="JPEG"?b.type="jpeg":m==="PNG "?b.type="png":b.type=zs),f==="Data"&&(b.binary=m==="BINA"||m==="FORM"),this.chunks[`${b.usage}:${p}`]=b}break}}}else if(t?.format==="infomap")for(let r in e){if(!Number.isInteger(+r))continue;let i=Object.assign({},e[r]);delete i.image,i.height&&i.width&&(i.imagesize={height:i.height,width:i.width},delete i.height,delete i.width),i.type=i.url.endsWith(".png")?"png":"jpeg",i.usage="pict",this.chunks[`pict:${r}`]=i}else if(!(Array.isArray(e)&&e.length===0))throw new Error("Unsupported Blorb.init data format");this.is_inited=!0}}getlibrary(){return null}get_chunk(e,t){return this.chunks[`${e}:${t}`]||null}get_cover_pict(){return this.coverimagenum??null}get_data_chunk(e){let t=this.chunks[`data:${e}`];return t?.content?{binary:t.binary,data:t.content}:null}get_debug_info(){return this.debugdata}get_exec_data(e){let t=this.chunks["exec:0"];return!t?.content||e&&t.blorbtype!==e?null:t.content}get_image_info(e){let t=this.chunks[`pict:${e}`];if(!t)return null;!t.imagesize&&t.content&&(t.type==="jpeg"?t.imagesize=Df(t.content):t.type==="png"&&(t.imagesize=Bf(t.content)));let r=Object.assign({image:e},t);return r.imagesize&&(r.height=r.imagesize.height,r.width=r.imagesize.width),r}get_image_url(e){let t=this.chunks[`pict:${e}`];return t?t.url?t.url:t.type!==zs&&t.content?(t.url=URL.createObjectURL(new Blob([t.content],{type:`image/${t.type}`})),t.url):null:null}get_metadata(e){return this.metadata[e]}inited(){return this.is_inited}};function Df(n){let e=new Ie(n),t=0;for(;t<e.byteLength;){if(e.getUint8(t)!==255)return;for(;e.getUint8(t)===255;)t++;let r=e.getUint8(t++);if(r===1||r>=208&&r<=217)continue;let i=e.getUint16(t);if(r>=192&&r<=207&&r!==200)return i<7?void 0:{height:e.getUint16(t+3),width:e.getUint16(t+5)};t+=i}}function Bf(n){let e=new Ie(n);if(e.getFourCC(0)!=="\x89PNG")return;let t=8;for(;t<e.byteLength;){let r=e.getUint32(t),i=e.getFourCC(t+4);if(t+=8,i==="IHDR")return{height:e.getInt32(t+4),width:e.getInt32(t)};t+=r+4}}var Eo={buffercharheight:1,buffercharwidth:1,buffermarginx:0,buffermarginy:0,graphicsmarginx:0,graphicsmarginy:0,gridcharheight:1,gridcharwidth:1,gridmarginx:0,gridmarginy:0,height:50,inspacingx:0,inspacingy:0,outspacingx:0,outspacingy:0,width:80},Fo={8:"delete",9:"tab",13:"return",27:"escape",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",112:"func1",113:"func2",114:"func3",115:"func4",116:"func5",117:"func6",118:"func7",119:"func8",120:"func9",121:"func10",122:"func11",123:"func12"},Uo=40,Co=13,Ro=38,ni="\xA0";var Hs="-10000px",Do="0.1.0";function Bo(n){switch(n){case"command":case"transcript":return".txt";case"save":return".glksave";default:return".glkdata"}}var Kr=class{constructor(){this.classname="GlkOte";this.version=Do;this.accept_func=()=>{};this.autorestoring=!1;this.current_metrics=Object.assign({},Eo);this.disabled=!1;this.generation=0;this.is_inited=!1;this.options={};this.timer=null;this.waiting_for_update=!1}async init(e){if(!e)return this.error("no options provided");if(!e.accept)return this.error("an accept function was not given to GlkOte");this.options=e,this.accept_func=e.accept,e.Blorb&&(this.Blorb=e.Blorb),e.Dialog&&(this.Dialog=e.Dialog),this.is_inited=!0,this.send_event({type:"init"})}error(e){throw typeof e=="string"?new Error(e):e}extevent(e){this.send_event({type:"external",value:e})}getdomcontext(){throw new Error("getdomcontext is not applicable to this GlkOte library")}getdomid(e){throw new Error("getdomid is not applicable to this GlkOte library")}getinterface(){return this.options}getlibrary(e){switch(e){case"Blorb":return this.Blorb;case"Dialog":return this.Dialog;default:return null}}inited(){return this.is_inited}log(e){console.log(e)}setdomcontext(e){throw new Error("setdomcontext is not applicable to this GlkOte library")}update(e){try{if(this.autorestoring=!1,this.waiting_for_update=!1,e.type==="error")return this.error(e.message);if(e.type==="pass")return;if(e.type==="retry"){setTimeout(()=>this.send_event({type:"refresh"}),2e3);return}if(e.type!=="update")return this.error(`Unknown update type: ${e.type}`);if(e.gen===this.generation){this.log(`Ignoring repeated generation number: ${e.gen}`);return}this.generation=e.gen,this.disabled&&this.disable(!1),e.input&&this.cancel_inputs(e.input),e.windows&&this.update_windows(e.windows),e.content&&this.update_content(e.content),e.input&&this.update_inputs(e.input),e.schannels&&this.Blorb&&this.update_schannels(e.schannels),e.timer!==void 0&&(this.timer&&(clearInterval(this.timer),this.timer=null),e.timer&&(this.timer=setInterval(()=>this.ontimer(),e.timer))),e.specialinput&&this.handle_specialinput(e.specialinput),this.disabled=!1,(e.disable||e.specialinput)&&this.disable(!0),e.autorestore&&(this.autorestoring=!0,this.autorestore(e.autorestore)),typeof e.page_margin_bg<"u"&&this.options.set_body_to_page_bg&&this.set_page_bg(e.page_margin_bg),e.disable&&this.exit()}catch(t){this.error(t)}}warning(e){console.warn(e)}autorestore(e){}capabilities(){return["timer"]}exit(){}handle_specialinput(e){if(e.type==="fileref_prompt"){let t=r=>this.send_event({type:"specialresponse",response:"fileref_prompt",value:r});try{this.Dialog?this.Dialog.async?this.Dialog.prompt(Bo(e.filetype),e.filemode!=="read").then(r=>{t(r?{filename:r}:null)}):this.Dialog.open(e.filemode!=="read",e.filetype,e.gameid,t):setTimeout(()=>t(null),0)}catch(r){this.log(`Unable to open file dialog: ${r}`),setTimeout(()=>t(null),0)}}else this.error(`Request for unknown special input type: ${e.type}`)}ontimer(){!this.disabled&&this.timer&&this.send_event({type:"timer"})}save_allstate(){}send_event(e){if(!(this.disabled&&e.type!=="specialresponse")){if(this.waiting_for_update){console.log("Trying to send event when waiting for input",e);return}switch(this.waiting_for_update=!0,e.gen=this.generation,e.type){case"arrange":e.metrics=this.current_metrics;break;case"init":e.metrics=this.current_metrics,e.support=this.capabilities();break;case"specialresponse":e.response="fileref_prompt";break}this.accept_func(e)}}set_page_bg(e){}update_schannels(e){}};var ru={},To=new Map;async function Io(n,e,t){let r=To.get(e);if(r)return r;let i=tu(n,e,t);return To.set(e,i),i.then(s=>{To.set(e,s)}),i}async function tu(n,e,t){if(n.single_file){let u=document.getElementById(e),f=u.text;if(e.endsWith(".js"))return import(`data:text/javascript,${encodeURIComponent(f)}`);if(!e.endsWith(".wasm"))throw new Error(`Can't load ${e} in single file mode`);let p=await rt(f);return u.type.endsWith(";gzip")&&(p=tr(p)),p}let r=n.lib_path??ru.url,i;try{i=new URL(e,r)}catch{i=r+e}if(e.endsWith(".js"))return import(i+"");let s=await fetch(i);return ii(s,t)}async function rt(n){if(n.length<3e7)return Zs(n);let t=[],r=0;for(;r<n.length;)t.push(await Zs(n.substring(r,r+=3e7)));let i=new Blob(t);return new Uint8Array(await i.arrayBuffer())}async function Zs(n){let e=await fetch(`data:application/octet-stream;base64,${n}`);if(!e.ok)throw new Error(`Could not parse base64: ${e.status}`);return new Uint8Array(await e.arrayBuffer())}async function ii(n,e){if(!n.ok)throw new Error(`Could not fetch ${n.url}, got ${n.status}`);if(!e)return new Uint8Array(await n.arrayBuffer());let t=[],r=0,i=n.body.getReader();for(;;){let{done:u,value:f}=await i.read();if(u)break;t.push([r,f]),e(f.length),r+=f.length}let s=new Uint8Array(r);for(let[u,f]of t)s.set(f,u);return s}var Wa=Al(Ks(),1);function nt(n){if(typeof n!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(n))}function Xs(n,e){for(var t="",r=0,i=-1,s=0,u,f=0;f<=n.length;++f){if(f<n.length)u=n.charCodeAt(f);else{if(u===47)break;u=47}if(u===47){if(!(i===f-1||s===1))if(i!==f-1&&s===2){if(t.length<2||r!==2||t.charCodeAt(t.length-1)!==46||t.charCodeAt(t.length-2)!==46){if(t.length>2){var p=t.lastIndexOf("/");if(p!==t.length-1){p===-1?(t="",r=0):(t=t.slice(0,p),r=t.length-1-t.lastIndexOf("/")),i=f,s=0;continue}}else if(t.length===2||t.length===1){t="",r=0,i=f,s=0;continue}}e&&(t.length>0?t+="/..":t="..",r=2)}else t.length>0?t+="/"+n.slice(i+1,f):t=n.slice(i+1,f),r=f-i-1;i=f,s=0}else u===46&&s!==-1?++s:s=-1}return t}function nu(n,e){var t=e.dir||e.root,r=e.base||(e.name||"")+(e.ext||"");return t?t===e.root?t+r:t+n+r:r}var Fe={process_cwd:"",setCWD:function(e){Fe.process_cwd=e},resolve:function(){for(var e="",t=!1,r,i=arguments.length-1;i>=-1&&!t;i--){var s;i>=0?s=arguments[i]:(r===void 0&&(r=Fe.process_cwd),s=r),nt(s),s.length!==0&&s+"/"!==e&&(e=s+"/"+e,t=s.charCodeAt(0)===47)}return e=Xs(e,!t),t?e.length>0?"/"+e:"/":e.length>0?e:"."},normalize:function(e){if(nt(e),e.length===0)return".";var t=e.charCodeAt(0)===47,r=e.charCodeAt(e.length-1)===47;return e=Xs(e,!t),e.length===0&&!t&&(e="."),e.length>0&&r&&(e+="/"),t?"/"+e:e},isAbsolute:function(e){return nt(e),e.length>0&&e.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var e,t=0;t<arguments.length;++t){var r=arguments[t];nt(r),r.length>0&&(e===void 0?e=r:e+="/"+r)}return e===void 0?".":Fe.normalize(e)},relative:function(e,t){if(nt(e),nt(t),e===t)return"";let r=e.replaceAll("\\","/"),i=t.replaceAll("\\","/");if(r!=e&&i!=t)return Fe.relative(r,i).replaceAll("/","\\");if(r!=e)return Fe.relative(r,t).replaceAll("/","\\");if(i!=t)return Fe.relative(e,i);if(e=Fe.resolve(e),t=Fe.resolve(t),e===t)return"";for(var s=1;s<e.length&&e.charCodeAt(s)===47;++s);for(var u=e.length,f=u-s,p=1;p<t.length&&t.charCodeAt(p)===47;++p);for(var _=t.length,y=_-p,m=f<y?f:y,b=-1,x=0;x<=m;++x){if(x===m){if(y>m){if(t.charCodeAt(p+x)===47)return t.slice(p+x+1);if(x===0)return t.slice(p+x)}else f>m&&(e.charCodeAt(s+x)===47?b=x:x===0&&(b=0));break}var U=e.charCodeAt(s+x),E=t.charCodeAt(p+x);if(U!==E)break;U===47&&(b=x)}var T="";for(x=s+b+1;x<=u;++x)(x===u||e.charCodeAt(x)===47)&&(T.length===0?T+="..":T+="/..");return T.length>0?T+t.slice(p+b):(p+=b,t.charCodeAt(p)===47&&++p,t.slice(p))},_makeLong:function(e){return e},dirname:function(e){if(nt(e),e.length===0)return".";for(var t=e.charCodeAt(0),r=t===47,i=-1,s=!0,u=e.length-1;u>=1;--u)if(t=e.charCodeAt(u),t===47){if(!s){i=u;break}}else s=!1;return i===-1?r?"/":".":r&&i===1?"//":e.slice(0,i)},basename:function(e,t){if(t!==void 0&&typeof t!="string")throw new TypeError('"ext" argument must be a string');nt(e);var r=0,i=-1,s=!0,u;if(t!==void 0&&t.length>0&&t.length<=e.length){if(t.length===e.length&&t===e)return"";var f=t.length-1,p=-1;for(u=e.length-1;u>=0;--u){var _=e.charCodeAt(u);if(_===47){if(!s){r=u+1;break}}else p===-1&&(s=!1,p=u+1),f>=0&&(_===t.charCodeAt(f)?--f===-1&&(i=u):(f=-1,i=p))}return r===i?i=p:i===-1&&(i=e.length),e.slice(r,i)}else{for(u=e.length-1;u>=0;--u)if(e.charCodeAt(u)===47){if(!s){r=u+1;break}}else i===-1&&(s=!1,i=u+1);return i===-1?"":e.slice(r,i)}},extname:function(e){nt(e);for(var t=-1,r=0,i=-1,s=!0,u=0,f=e.length-1;f>=0;--f){var p=e.charCodeAt(f);if(p===47){if(!s){r=f+1;break}continue}i===-1&&(s=!1,i=f+1),p===46?t===-1?t=f:u!==1&&(u=1):t!==-1&&(u=-1)}return t===-1||i===-1||u===0||u===1&&t===i-1&&t===r+1?"":e.slice(t,i)},format:function(e){if(e===null||typeof e!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof e);return nu("/",e)},parse:function(e){nt(e);var t={root:"",dir:"",base:"",ext:"",name:""};if(e.length===0)return t;var r=e.charCodeAt(0),i=r===47,s;i?(t.root="/",s=1):s=0;for(var u=-1,f=0,p=-1,_=!0,y=e.length-1,m=0;y>=s;--y){if(r=e.charCodeAt(y),r===47){if(!_){f=y+1;break}continue}p===-1&&(_=!1,p=y+1),r===46?u===-1?u=y:m!==1&&(m=1):u!==-1&&(m=-1)}return u===-1||p===-1||m===0||m===1&&u===p-1&&u===f+1?p!==-1&&(f===0&&i?t.base=t.name=e.slice(1,p):t.base=t.name=e.slice(f,p)):(f===0&&i?(t.name=e.slice(1,u),t.base=e.slice(1,p)):(t.name=e.slice(f,u),t.base=e.slice(f,p)),t.ext=e.slice(u,p)),f>0?t.dir=e.slice(0,f-1):i&&(t.dir="/"),t},sep:"/",delimiter:":",win32:null,posix:null};Fe.posix=Fe;function ye(){}function iu(n,e){for(let t in e)n[t]=e[t];return n}function Mo(n){return n()}function oi(){return Object.create(null)}function xe(n){n.forEach(Mo)}function Xr(n){return typeof n=="function"}function it(n,e){return n!=n?e==e:n!==e||n&&typeof n=="object"||typeof n=="function"}function ea(n){return Object.keys(n).length===0}function ta(n,e,t,r){if(n){let i=ra(n,e,t,r);return n[0](i)}}function ra(n,e,t,r){return n[1]&&r?iu(t.ctx.slice(),n[1](r(e))):t.ctx}function na(n,e,t,r){if(n[2]&&r){let i=n[2](r(t));if(e.dirty===void 0)return i;if(typeof i=="object"){let s=[],u=Math.max(e.dirty.length,i.length);for(let f=0;f<u;f+=1)s[f]=e.dirty[f]|i[f];return s}return e.dirty|i}return e.dirty}function ia(n,e,t,r,i,s){if(i){let u=ra(e,t,r,s);n.p(u,i)}}function oa(n){if(n.ctx.length>32){let e=[],t=n.ctx.length/32;for(let r=0;r<t;r++)e[r]=-1;return e}return-1}function si(n){return n&&Xr(n.destroy)?n.destroy:ye}var Go=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;var ai=class n{_listeners="WeakMap"in Go?new WeakMap:void 0;_observer=void 0;options;constructor(e){this.options=e}observe(e,t){return this._listeners.set(e,t),this._getObserver().observe(e,this.options),()=>{this._listeners.delete(e),this._observer.unobserve(e)}}_getObserver(){return this._observer??(this._observer=new ResizeObserver(e=>{for(let t of e)n.entries.set(t.target,t),this._listeners.get(t.target)?.(t)}))}};ai.entries="WeakMap"in Go?new WeakMap:void 0;var sa=!1;function aa(){sa=!0}function la(){sa=!1}function G(n,e){n.appendChild(e)}function V(n,e,t){n.insertBefore(e,t||null)}function Q(n){n.parentNode&&n.parentNode.removeChild(n)}function li(n,e){for(let t=0;t<n.length;t+=1)n[t]&&n[t].d(e)}function N(n){return document.createElement(n)}function ut(n){return document.createElementNS("http://www.w3.org/2000/svg",n)}function we(n){return document.createTextNode(n)}function ae(){return we(" ")}function fa(){return we("")}function fe(n,e,t,r){return n.addEventListener(e,t,r),()=>n.removeEventListener(e,t,r)}function ua(n){return function(e){return e.preventDefault(),n.call(this,e)}}function ca(n){return function(e){return e.stopPropagation(),n.call(this,e)}}function k(n,e,t){t==null?n.removeAttribute(e):n.getAttribute(e)!==t&&n.setAttribute(e,t)}function da(n){return Array.from(n.childNodes)}function We(n,e){e=""+e,n.data!==e&&(n.data=e)}function nr(n,e){n.value=e??""}function Lo(n,e,t){for(let r=0;r<n.options.length;r+=1){let i=n.options[r];if(i.__value===e){i.selected=!0;return}}(!t||e!==void 0)&&(n.selectedIndex=-1)}function pa(n){let e=n.querySelector(":checked");return e&&e.__value}function yt(n,e,t){n.classList.toggle(e,!!t)}function fi(n,e,{bubbles:t=!1,cancelable:r=!1}={}){return new CustomEvent(n,{detail:e,bubbles:t,cancelable:r})}function ha(n){let e={};return n.childNodes.forEach(t=>{e[t.slot||"default"]=!0}),e}var vt;function ct(n){vt=n}function _a(){if(!vt)throw new Error("Function called outside component initialization");return vt}function No(){let n=_a();return(e,t,{cancelable:r=!1}={})=>{let i=n.$$.callbacks[e];if(i){let s=fi(e,t,{cancelable:r});return i.slice().forEach(u=>{u.call(n,s)}),!s.defaultPrevented}return!0}}var Rt=[];var Xe=[],or=[],Vo=[],du=Promise.resolve(),jo=!1;function ma(){jo||(jo=!0,du.then(ui))}function Dt(n){or.push(n)}function $o(n){Vo.push(n)}var Qo=new Set,ir=0;function ui(){if(ir!==0)return;let n=vt;do{try{for(;ir<Rt.length;){let e=Rt[ir];ir++,ct(e),pu(e.$$)}}catch(e){throw Rt.length=0,ir=0,e}for(ct(null),Rt.length=0,ir=0;Xe.length;)Xe.pop()();for(let e=0;e<or.length;e+=1){let t=or[e];Qo.has(t)||(Qo.add(t),t())}or.length=0}while(Rt.length);for(;Vo.length;)Vo.pop()();jo=!1,Qo.clear(),ct(n)}function pu(n){if(n.fragment!==null){n.update(),xe(n.before_update);let e=n.dirty;n.dirty=[-1],n.fragment&&n.fragment.p(n.ctx,e),n.after_update.forEach(Dt)}}function ga(n){let e=[],t=[];or.forEach(r=>n.indexOf(r)===-1?e.push(r):t.push(r)),t.forEach(r=>r()),or=e}var ci=new Set,Bt;function Po(){Bt={r:0,c:[],p:Bt}}function zo(){Bt.r||xe(Bt.c),Bt=Bt.p}function Ue(n,e){n&&n.i&&(ci.delete(n),n.i(e))}function $e(n,e,t,r){if(n&&n.o){if(ci.has(n))return;ci.add(n),Bt.c.push(()=>{ci.delete(n),r&&(t&&n.d(1),r())}),n.o(e)}else r&&r()}function wt(n){return n?.length!==void 0?n:Array.from(n)}var hu=["allowfullscreen","allowpaymentrequest","async","autofocus","autoplay","checked","controls","default","defer","disabled","formnovalidate","hidden","inert","ismap","loop","multiple","muted","nomodule","novalidate","open","playsinline","readonly","required","reversed","selected"],_u=new Set([...hu]);function Jo(n,e,t){let r=n.$$.props[e];r!==void 0&&(n.$$.bound[r]=t,t(n.$$.ctx[r]))}function sr(n){n&&n.c()}function Tt(n,e,t){let{fragment:r,after_update:i}=n.$$;r&&r.m(e,t),Dt(()=>{let s=n.$$.on_mount.map(Mo).filter(Xr);n.$$.on_destroy?n.$$.on_destroy.push(...s):xe(s),n.$$.on_mount=[]}),i.forEach(Dt)}function It(n,e){let t=n.$$;t.fragment!==null&&(ga(t.after_update),xe(t.on_destroy),t.fragment&&t.fragment.d(e),t.on_destroy=t.fragment=null,t.ctx=[])}function gu(n,e){n.$$.dirty[0]===-1&&(Rt.push(n),ma(),n.$$.dirty.fill(0)),n.$$.dirty[e/31|0]|=1<<e%31}function ot(n,e,t,r,i,s,u=null,f=[-1]){let p=vt;ct(n);let _=n.$$={fragment:null,ctx:[],props:s,update:ye,not_equal:i,bound:oi(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(p?p.$$.context:[])),callbacks:oi(),dirty:f,skip_bound:!1,root:e.target||p.$$.root};u&&u(_.root);let y=!1;if(_.ctx=t?t(n,e.props||{},(m,b,...x)=>{let U=x.length?x[0]:b;return _.ctx&&i(_.ctx[m],_.ctx[m]=U)&&(!_.skip_bound&&_.bound[m]&&_.bound[m](U),y&&gu(n,m)),b}):[],_.update(),y=!0,xe(_.before_update),_.fragment=r?r(_.ctx):!1,e.target){if(e.hydrate){aa();let m=da(e.target);_.fragment&&_.fragment.l(m),m.forEach(Q)}else _.fragment&&_.fragment.c();e.intro&&Ue(n.$$.fragment),Tt(n,e.target,e.anchor),la(),ui()}ct(p)}var yu;typeof HTMLElement=="function"&&(yu=class extends HTMLElement{$$ctor;$$s;$$c;$$cn=!1;$$d={};$$r=!1;$$p_d={};$$l={};$$l_u=new Map;constructor(n,e,t){super(),this.$$ctor=n,this.$$s=e,t&&this.attachShadow({mode:"open"})}addEventListener(n,e,t){if(this.$$l[n]=this.$$l[n]||[],this.$$l[n].push(e),this.$$c){let r=this.$$c.$on(n,e);this.$$l_u.set(e,r)}super.addEventListener(n,e,t)}removeEventListener(n,e,t){if(super.removeEventListener(n,e,t),this.$$c){let r=this.$$l_u.get(e);r&&(r(),this.$$l_u.delete(e))}}async connectedCallback(){if(this.$$cn=!0,!this.$$c){let n=function(i){return()=>{let s;return{c:function(){s=N("slot"),i!=="default"&&k(s,"name",i)},m:function(p,_){V(p,s,_)},d:function(p){p&&Q(s)}}}};if(await Promise.resolve(),!this.$$cn||this.$$c)return;let e={},t=ha(this);for(let i of this.$$s)i in t&&(e[i]=[n(i)]);for(let i of this.attributes){let s=this.$$g_p(i.name);s in this.$$d||(this.$$d[s]=Ho(s,i.value,this.$$p_d,"toProp"))}for(let i in this.$$p_d)!(i in this.$$d)&&this[i]!==void 0&&(this.$$d[i]=this[i],delete this[i]);this.$$c=new this.$$ctor({target:this.shadowRoot||this,props:{...this.$$d,$$slots:e,$$scope:{ctx:[]}}});let r=()=>{this.$$r=!0;for(let i in this.$$p_d)if(this.$$d[i]=this.$$c.$$.ctx[this.$$c.$$.props[i]],this.$$p_d[i].reflect){let s=Ho(i,this.$$d[i],this.$$p_d,"toAttribute");s==null?this.removeAttribute(this.$$p_d[i].attribute||i):this.setAttribute(this.$$p_d[i].attribute||i,s)}this.$$r=!1};this.$$c.$$.after_update.push(r),r();for(let i in this.$$l)for(let s of this.$$l[i]){let u=this.$$c.$on(i,s);this.$$l_u.set(s,u)}this.$$l={}}}attributeChangedCallback(n,e,t){this.$$r||(n=this.$$g_p(n),this.$$d[n]=Ho(n,t,this.$$p_d,"toProp"),this.$$c?.$set({[n]:this.$$d[n]}))}disconnectedCallback(){this.$$cn=!1,Promise.resolve().then(()=>{!this.$$cn&&this.$$c&&(this.$$c.$destroy(),this.$$c=void 0)})}$$g_p(n){return Object.keys(this.$$p_d).find(e=>this.$$p_d[e].attribute===n||!this.$$p_d[e].attribute&&e.toLowerCase()===n)||n}});function Ho(n,e,t,r){let i=t[n]?.type;if(e=i==="Boolean"&&typeof e!="boolean"?e!=null:e,!r||!t[n])return e;if(r==="toAttribute")switch(i){case"Object":case"Array":return e==null?null:JSON.stringify(e);case"Boolean":return e?"":null;case"Number":return e??null;default:return e}else switch(i){case"Object":case"Array":return e&&JSON.parse(e);case"Boolean":return e;case"Number":return e!=null?+e:e;default:return e}}var Ne=class{$$=void 0;$$set=void 0;$destroy(){It(this,1),this.$destroy=ye}$on(e,t){if(!Xr(t))return ye;let r=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return r.push(t),()=>{let i=r.indexOf(t);i!==-1&&r.splice(i,1)}}$set(e){this.$$set&&!ea(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}};var ya="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(ya);function vu(n){let e,t,r,i,s,u,f,p,_,y,m,b,x,U=n[8].default,E=ta(U,n,n[7],null);return{c(){e=N("dialog"),t=N("div"),r=N("div"),i=N("div"),s=we(n[3]),u=we("\xA0"),f=ae(),p=N("button"),p.textContent="\u2716",_=ae(),E&&E.c(),k(i,"id","title"),k(i,"class","svelte-1j9ahxx"),k(p,"class","close svelte-1j9ahxx"),k(p,"aria-label","Close"),k(r,"class","head svelte-1j9ahxx"),k(t,"class","inner svelte-1j9ahxx"),k(e,"class",y="asyncglk_ui "+n[0]+" svelte-1j9ahxx"),yt(e,"fullscreen",n[1]),yt(e,"manually_positioned",typeof visualViewport<"u")},m(T,I){V(T,e,I),G(e,t),G(t,r),G(r,i),G(i,s),G(i,u),G(r,f),G(r,p),G(t,_),E&&E.m(t,null),n[9](e),m=!0,b||(x=[fe(p,"click",n[4]),fe(e,"close",n[4])],b=!0)},p(T,[I]){(!m||I&8)&&We(s,T[3]),E&&E.p&&(!m||I&128)&&ia(E,U,T,T[7],m?na(U,T[7],I,null):oa(T[7]),null),(!m||I&1&&y!==(y="asyncglk_ui "+T[0]+" svelte-1j9ahxx"))&&k(e,"class",y),(!m||I&3)&&yt(e,"fullscreen",T[1]),(!m||I&1)&&yt(e,"manually_positioned",typeof visualViewport<"u")},i(T){m||(Ue(E,T),m=!0)},o(T){$e(E,T),m=!1},d(T){T&&Q(e),E&&E.d(T),n[9](null),b=!1,xe(x)}}}function wu(n,e,t){let{$$slots:r={},$$scope:i}=e,s,{extra_class:u=""}=e,{fullscreen:f=!1}=e,p,_="";async function y(E){t(3,_=E);let T=new Promise(I=>p=I);return s.showModal(),visualViewport&&(visualViewport.addEventListener("resize",x),f&&t(2,s.style.height=visualViewport.height+"px",s),t(2,s.style.top=(visualViewport.height-s.offsetHeight)/2+"px",s)),T}function m(E){s.close(),visualViewport&&(visualViewport.removeEventListener("resize",x),t(2,s.style.height="",s)),p(E)}function b(){m(!1)}function x(){gt()||(f&&t(2,s.style.height=visualViewport.height+"px",s),t(2,s.style.top=(visualViewport.height-s.offsetHeight)/2+"px",s))}function U(E){Xe[E?"unshift":"push"](()=>{s=E,t(2,s)})}return n.$$set=E=>{"extra_class"in E&&t(0,u=E.extra_class),"fullscreen"in E&&t(1,f=E.fullscreen),"$$scope"in E&&t(7,i=E.$$scope)},[u,f,s,_,b,y,m,i,r,U]}var qo=class extends Ne{constructor(e){super(),ot(this,e,wu,vu,it,{extra_class:0,fullscreen:1,open:5,resolve:6})}get open(){return this.$$.ctx[5]}get resolve(){return this.$$.ctx[6]}},di=qo;function va(n){let e,t,r,i;return{c(){e=N("textarea"),k(e,"id","val_input"),k(e,"autocapitalize","off"),k(e,"rows","1"),k(e,"class","svelte-1b53z4t")},m(s,u){V(s,e,u),r||(i=[fe(e,"keydown",n[5]),si(t=n[4].call(null,e))],r=!0)},p:ye,d(s){s&&Q(e),r=!1,xe(i)}}}function wa(n){let e,t,r;return{c(){e=N("button"),e.textContent="Cancel",k(e,"class","close")},m(i,s){V(i,e,s),t||(r=fe(e,"click",n[3]),t=!0)},p:ye,d(i){i&&Q(e),t=!1,r()}}}function bu(n){let e,t,r,i,s,u,f,p,_,y,m,b=n[1]===Wt&&va(n),x=n[1]!==pi&&wa(n);return{c(){e=N("p"),t=we(n[0]),r=ae(),i=N("div"),b&&b.c(),s=ae(),u=N("div"),f=N("div"),x&&x.c(),p=ae(),_=N("button"),_.textContent="Ok",k(_,"class","submit"),k(u,"class","foot uirow")},m(U,E){V(U,e,E),G(e,t),V(U,r,E),V(U,i,E),b&&b.m(i,null),V(U,s,E),V(U,u,E),G(u,f),x&&x.m(f,null),G(f,p),G(f,_),y||(m=fe(_,"click",n[6]),y=!0)},p(U,E){E&1&&We(t,U[0]),U[1]===Wt?b?b.p(U,E):(b=va(U),b.c(),b.m(i,null)):b&&(b.d(1),b=null),U[1]!==pi?x?x.p(U,E):(x=wa(U),x.c(),x.m(f,p)):x&&(x.d(1),x=null)},d(U){U&&(Q(e),Q(r),Q(i),Q(s),Q(u)),b&&b.d(),x&&x.d(),y=!1,m()}}}function xu(n){let e,t,r={$$slots:{default:[bu]},$$scope:{ctx:n}};return e=new di({props:r}),n[10](e),{c(){sr(e.$$.fragment)},m(i,s){Tt(e,i,s),t=!0},p(i,[s]){let u={};s&4099&&(u.$$scope={dirty:s,ctx:i}),e.$set(u)},i(i){t||(Ue(e.$$.fragment,i),t=!0)},o(i){$e(e.$$.fragment,i),t=!1},d(i){n[10](null),It(e,i)}}}function ku(n,e,t){let r,{initial:i=void 0}=e,{message:s}=e,{mode:u}=e,{title:f}=e,p;function _(){let E=r.open(f);return p&&(p.value=i||"",p.focus()),E}function y(){r.resolve(!1)}function m(E){p=E,p.focus(),p.value=i||""}function b(E){E.code==="Enter"&&(x(),E.preventDefault())}function x(){if(u===Wt){let E=p.value.trim();r.resolve(E||!1)}else r.resolve(!0)}function U(E){Xe[E?"unshift":"push"](()=>{r=E,t(2,r)})}return n.$$set=E=>{"initial"in E&&t(7,i=E.initial),"message"in E&&t(0,s=E.message),"mode"in E&&t(1,u=E.mode),"title"in E&&t(8,f=E.title)},[s,u,r,y,m,b,x,i,f,_,U]}var Yo=class extends Ne{constructor(e){super(),ot(this,e,ku,xu,it,{initial:7,message:0,mode:1,title:8,open:9})}get open(){return this.$$.ctx[9]}},hi=Yo;var pi=0,Zo=1,Wt=2,ar=class{constructor(){this.browseable=!1;this.next=this}async delete(e){}async exists(e){return null}async read(e){return null}async write(e){}};async function _i(n,e){let t=new hi({target:document.body,props:{message:e,mode:pi,title:n}});await t.open(),t.$destroy()}var mi=class{constructor(e){this.browseable=!1;this.next=new ar;this.store=new Map;this.options=e}async download(e,t){let r=await Su(this.options,e,t),i=Au(e);return this.store.set(i,r),i}async upload(e){let t=await Ko(e),r="/upload/"+e.name;return this.store.set(r,t),r}async delete(e){if(this.store.has(e))this.store.delete(e);else return this.next.delete(e)}async exists(e){return this.store.has(e)?!0:this.next.exists(e)}async read(e){return this.store.has(e)?this.store.get(e):this.next.read(e)}write(e){return this.next.write(e)}};async function Su(n,e,t){let r=new URL(e,document.URL),i=r.hostname,s=r.protocol===document.location.protocol,u=i===document.location.hostname,f;if(r.protocol==="embedded:"){let m=document.getElementById(r.pathname),b=m.text,x=await rt(b);return m.type.endsWith(";gzip")&&(x=tr(x)),x}let p=s&&u||r.protocol==="data:",_=n.direct_domains;if(!p&&_){for(let m of _)if(i.endsWith(m)){r.protocol="https:",p=!0;break}}if(p)try{f=await fetch(""+r)}catch{throw new Error("Failed to fetch storyfile (possible CORS error)")}else if(n.use_proxy&&n.proxy_url)f=await fetch(`${n.proxy_url}?url=${r}`);else throw new Error("Storyfile not in list of direct domains and proxy disabled");if(!f.ok)throw new Error(`Could not fetch storyfile, got ${f.status}`);let y=await ii(f,t);if(e.endsWith(".js")){let m=rr.decode(y),b=/processBase64Zcode\(['"]([a-zA-Z0-9+/=]+)['"]\)/.exec(m);if(!b)throw new Error("Abnormal JSified story");return rt(b[1])}return y}function Ko(n){return new Promise((e,t)=>{let r=new FileReader;r.onerror=()=>t(r.error),r.onload=()=>e(new Uint8Array(r.result)),r.readAsArrayBuffer(n)})}function Au(n){return n.startsWith("https:")?"/download/https/"+n.substring(8):"/download/http/"+n.substring(7)}var Eu=["\u04A0\u04BF\u0500\u051F\u0680\u06BF\u0760\u079F\u07C0\u07DF\u1000\u101F\u10A0\u10BF\u1100\u115F\u1180\u119F\u11E0\u123F\u1260\u127F\u12E0\u12FF\u1320\u133F\u13A0\u13DF\u1420\u165F\u16A0\u16DF\u1780\u179F\u1820\u185F\u18C0\u18DF\u1980\u199F\u19E0\u19FF\u1A20\u1A3F\u1BC0\u1BDF\u1C00\u1C1F\u1D00\u1D1F\u21E0\u21FF\u22C0\u22DF\u2340\u23DF\u2400\u241F\u2500\u275F\u2780\u27BF\u2800\u297F\u29A0\u29BF\u2A20\u2A5F\u2A80\u2ABF\u2AE0\u2B5F\u2C00\u2C1F\u2C80\u2CDF\u2D00\u2D1F\u2D40\u2D5F\u2EA0\u2EDF\u31C0\u31DF\u3400\u4D9F\u4DC0\u9FBF\uA000\uA47F\uA4A0\uA4BF\uA500\uA5FF\uA640\uA65F\uA6A0\uA6DF\uA700\uA75F\uA780\uA79F\uA840\uA85F","\u0180\u019F\u0240\u029F"],gi={},Xo={};Eu.forEach((n,e)=>{let t=[];n.match(/../gu).forEach(i=>{let s=i.codePointAt(0),u=i.codePointAt(1);for(let f=s;f<=u;f++)t.push(String.fromCodePoint(f))});let r=15-8*e;gi[r]=t,t.forEach((i,s)=>{Xo[i]=[r,s]})});var es=n=>{let e=n.length,t="",r=0,i=0;for(let s=0;s<e;s++){let u=n[s];for(let f=7;f>=0;f--){let p=u>>f&1;r=(r<<1)+p,i++,i===15&&(t+=gi[i][r],r=0,i=0)}}if(i!==0){for(;!(i in gi);)r=(r<<1)+1,i++;t+=gi[i][r]}return t},ba=n=>{let e=n.length,t=new Uint8Array(Math.floor(e*15/8)),r=0,i=0,s=0;for(let u=0;u<e;u++){let f=n.charAt(u);if(!(f in Xo))throw new Error(`Unrecognised Base32768 character: ${f}`);let[p,_]=Xo[f];if(p!==15&&u!==e-1)throw new Error("Secondary character found before end of input at position "+String(u));for(let y=p-1;y>=0;y--){let m=_>>y&1;i=(i<<1)+m,s++,s===8&&(t[r]=i,r++,i=0,s=0)}}if(i!==(1<<s)-1)throw new Error("Padding mismatch");return new Uint8Array(t.buffer,0,r)};var ts="dialog_metadata",xa="dialog_storage_version";var en=class{constructor(e,t,r,i){this._metadata={};this.next=new ar;this.transaction=!1;this.browseable=i??!1,this.dirs=r,this.prefix=e,this.store=t,t===localStorage&&Uu()}async delete(e){if(e.startsWith(this.prefix))this.store.removeItem(e),await this.update_metadata(e,1);else return this.next.delete(e)}async exists(e){return e.startsWith(this.prefix)?this.store.getItem(e)!==null:this.next.exists(e)}async metadata(){return this._metadata=JSON.parse(this.store.getItem(ts)||"{}"),this._metadata[this.dirs.working+"/.dir"]={atime:0,mtime:0},this._metadata}async read(e){if(e.startsWith(this.prefix)){let t=this.store.getItem(e);return t!==null?(await this.update_metadata(e,2),ba(t)):null}else return this.next.read(e)}async rename(e,t,r){if(await this.transaction_start(),e){for(let i of Object.keys(this._metadata))if(i.startsWith(t)){let s=i.replace(t,r);await this.rename_file(i,s)}}else await this.rename_file(t,r);this.transaction_end()}async rename_file(e,t){let r=await this.read(e);await this.write({new_path:r}),await this.update_metadata(t,3,e),await this.delete(e)}async transaction_start(){let e=this.transaction;return this.transaction=!0,e||await this.metadata(),e}transaction_end(){this.transaction=!1,delete this._metadata[this.dirs.working+"/.dir"],this.store.setItem(ts,JSON.stringify(this._metadata))}async update_metadata(e,t,r){let i=Date.now();switch(this.transaction||await this.metadata(),t){case 1:delete this._metadata[e];break;case 2:this._metadata[e].atime=i;break;case 3:this._metadata[e]=this._metadata[r],delete this._metadata[r];break;case 4:this._metadata[e]||(this._metadata[e]={atime:i,mtime:i}),this._metadata[e].mtime=i}this.transaction||this.transaction_end()}async write(e){let t=await this.transaction_start(),r=!1,i=!1;for(let[s,u]of Object.entries(e))if(s.startsWith(this.prefix)){r=!0;try{this.store.setItem(s,es(u)),this.update_metadata(s,4)}catch{_i("localStorage full",`The file ${s.replace(/\//g,"/\u200B")} could not be written as your browser's localStorage is full! Please delete some files, and then try again.`)}delete e[s]}else i=!0;t||(this.transaction=!1,r&&this.transaction_end()),i&&this.next.write(e)}},Fu={data:"glkdata",save:"glksave",transcript:"txt"};function Uu(){let n=Date.now(),e=parseInt(localStorage.getItem(xa)||"0",10);if(e<2){console.log("Dialog: updating localStorage to version 2");let t={};for(let[r,i]of Object.entries(localStorage))if(r.startsWith("autosave:")&&localStorage.removeItem(r),r.startsWith("content:")){let s=/^content:(\w+):(\w*):(.+)$/.exec(r);if(s){let u=`/usr/${s[3]}.${Fu[s[1]]||s[1]}`;i!==""&&e<1&&(i=es(/\[[,\d]*\]/.test(i)?JSON.parse(i):Uint8Array.from(i,y=>y.charCodeAt(0)))),localStorage.setItem(u,i);let f="dirent"+r.substring(7),p=localStorage.getItem(f)||"",_=/^created:\d+,modified:(\d+)$/.exec(p);t[u]={atime:parseInt(_?.[1]||"",10)||n,mtime:parseInt(_?.[1]||"",10)||n},localStorage.removeItem(f)}localStorage.removeItem(r)}localStorage.setItem(ts,JSON.stringify(t)),localStorage.setItem(xa,"2")}if(e>2)throw new Error("dialog_storage_version is newer than this library supports")}function ka(n,e,t){let r=n.slice();return r[3]=e[t],r[5]=t,r}function Cu(n){let e;return{c(){e=N("span"),e.textContent="\xA0/\xA0",k(e,"class","slash svelte-909yjd")},m(t,r){V(t,e,r)},d(t){t&&Q(e)}}}function Ru(n){let e,t=(n[3]==="usr"?"My files":n[3])+"",r;return{c(){e=N("span"),r=we(t)},m(i,s){V(i,e,s),G(e,r)},p(i,s){s&1&&t!==(t=(i[3]==="usr"?"My files":i[3])+"")&&We(r,t)},d(i){i&&Q(e)}}}function Du(n){let e,t,r=(n[3]==="usr"?"My files":n[3])+"",i,s,u,f;return{c(){e=N("span"),t=N("button"),i=we(r),k(t,"class","flat svelte-909yjd"),k(t,"data-path",s="/"+n[0].slice(0,n[5]+1).join("/"))},m(p,_){V(p,e,_),G(e,t),G(t,i),u||(f=fe(t,"click",n[1]),u=!0)},p(p,_){_&1&&r!==(r=(p[3]==="usr"?"My files":p[3])+"")&&We(i,r),_&1&&s!==(s="/"+p[0].slice(0,p[5]+1).join("/"))&&k(t,"data-path",s)},d(p){p&&Q(e),u=!1,f()}}}function Sa(n){let e,t,r=n[5]!==0&&Cu(n);function i(f,p){return f[0][f[5]+1]?Du:Ru}let s=i(n,-1),u=s(n);return{c(){r&&r.c(),e=ae(),u.c(),t=fa()},m(f,p){r&&r.m(f,p),V(f,e,p),u.m(f,p),V(f,t,p)},p(f,p){s===(s=i(f,p))&&u?u.p(f,p):(u.d(1),u=s(f),u&&(u.c(),u.m(t.parentNode,t)))},d(f){f&&(Q(e),Q(t)),r&&r.d(f),u.d(f)}}}function Bu(n){let e,t=wt(n[0]),r=[];for(let i=0;i<t.length;i+=1)r[i]=Sa(ka(n,t,i));return{c(){e=N("div");for(let i=0;i<r.length;i+=1)r[i].c();k(e,"id","dirtree"),k(e,"class","svelte-909yjd")},m(i,s){V(i,e,s);for(let u=0;u<r.length;u+=1)r[u]&&r[u].m(e,null)},p(i,[s]){if(s&3){t=wt(i[0]);let u;for(u=0;u<t.length;u+=1){let f=ka(i,t,u);r[u]?r[u].p(f,s):(r[u]=Sa(f),r[u].c(),r[u].m(e,null))}for(;u<r.length;u+=1)r[u].d(1);r.length=t.length}},i:ye,o:ye,d(i){i&&Q(e),li(r,i)}}}function Tu(n,e,t){let{cur_dir:r}=e,i;function s(u){let f=u.target;t(2,r=f.dataset.path)}return n.$$set=u=>{"cur_dir"in u&&t(2,r=u.cur_dir)},n.$$.update=()=>{n.$$.dirty&4&&t(0,i=r.substring(1).split("/"))},[i,s,r]}var rs=class extends Ne{constructor(e){super(),ot(this,e,Tu,Bu,it,{cur_dir:2})}},Aa=rs;function Iu(n){let e,t;return{c(){e=ut("svg"),t=ut("path"),k(t,"stroke-linecap","round"),k(t,"stroke-linejoin","round"),k(t,"d","M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"),k(e,"xmlns","http://www.w3.org/2000/svg"),k(e,"fill","none"),k(e,"viewBox","0 0 24 24"),k(e,"height","20px"),k(e,"width","20px"),k(e,"stroke-width","1.5"),k(e,"stroke","currentColor"),k(e,"class","svelte-1wgzrj7")},m(r,i){V(r,e,i),G(e,t)},d(r){r&&Q(e)}}}function Wu(n){let e,t;return{c(){e=ut("svg"),t=ut("path"),k(t,"stroke-linecap","round"),k(t,"stroke-linejoin","round"),k(t,"d","M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"),k(e,"xmlns","http://www.w3.org/2000/svg"),k(e,"fill","none"),k(e,"viewBox","0 0 24 24"),k(e,"height","20px"),k(e,"width","20px"),k(e,"stroke-width","1.5"),k(e,"stroke","currentColor"),k(e,"class","svelte-1wgzrj7")},m(r,i){V(r,e,i),G(e,t)},d(r){r&&Q(e)}}}function Ou(n){let e,t;return{c(){e=ut("svg"),t=ut("path"),k(t,"stroke-linecap","round"),k(t,"stroke-linejoin","round"),k(t,"d","M10.125 2.25h-4.5c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125v-9M10.125 2.25h.375a9 9 0 0 1 9 9v.375M10.125 2.25A3.375 3.375 0 0 1 13.5 5.625v1.5c0 .621.504 1.125 1.125 1.125h1.5a3.375 3.375 0 0 1 3.375 3.375M9 15l2.25 2.25L15 12"),k(e,"xmlns","http://www.w3.org/2000/svg"),k(e,"fill","none"),k(e,"viewBox","0 0 24 24"),k(e,"height","20px"),k(e,"width","20px"),k(e,"stroke-width","1.5"),k(e,"stroke","currentColor"),k(e,"class","svelte-1wgzrj7")},m(r,i){V(r,e,i),G(e,t)},d(r){r&&Q(e)}}}function Mu(n){let e,t;return{c(){e=ut("svg"),t=ut("path"),k(t,"stroke-linecap","round"),k(t,"stroke-linejoin","round"),k(t,"d","M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z"),k(e,"xmlns","http://www.w3.org/2000/svg"),k(e,"fill","none"),k(e,"viewBox","0 0 24 24"),k(e,"height","20px"),k(e,"width","20px"),k(e,"stroke-width","1.5"),k(e,"stroke","currentColor"),k(e,"class","svelte-1wgzrj7")},m(r,i){V(r,e,i),G(e,t)},d(r){r&&Q(e)}}}function Ea(n){let e,t,r,i,s,u,f,p,_=!n[0].dir&&n[0].meta&&Fa(n);function y(x,U){return x[0].dir?Lu:Gu}let m=y(n,-1),b=m(n);return{c(){_&&_.c(),e=ae(),t=N("div"),b.c(),r=ae(),i=N("button"),i.textContent="Rename",s=ae(),u=N("button"),u.textContent="Delete",k(t,"class","actions svelte-1wgzrj7")},m(x,U){_&&_.m(x,U),V(x,e,U),V(x,t,U),b.m(t,null),G(t,r),G(t,i),G(t,s),G(t,u),f||(p=[fe(i,"click",n[8]),fe(u,"click",n[3])],f=!0)},p(x,U){!x[0].dir&&x[0].meta?_?_.p(x,U):(_=Fa(x),_.c(),_.m(e.parentNode,e)):_&&(_.d(1),_=null),m===(m=y(x,U))&&b?b.p(x,U):(b.d(1),b=m(x),b&&(b.c(),b.m(t,r)))},d(x){x&&(Q(e),Q(t)),_&&_.d(x),b.d(),f=!1,xe(p)}}}function Fa(n){let e,t,r=new Date(n[0].meta.mtime).toDateString()+"",i;return{c(){e=N("div"),t=we("Last modified: "),i=we(r),k(e,"class","date svelte-1wgzrj7")},m(s,u){V(s,e,u),G(e,t),G(e,i)},p(s,u){u&1&&r!==(r=new Date(s[0].meta.mtime).toDateString()+"")&&We(i,r)},d(s){s&&Q(e)}}}function Gu(n){let e,t,r;return{c(){e=N("button"),e.textContent="Download"},m(i,s){V(i,e,s),t||(r=fe(e,"click",n[5]),t=!0)},p:ye,d(i){i&&Q(e),t=!1,r()}}}function Lu(n){let e,t,r;return{c(){e=N("button"),e.textContent="Open"},m(i,s){V(i,e,s),t||(r=fe(e,"click",n[7]),t=!0)},p:ye,d(i){i&&Q(e),t=!1,r()}}}function Nu(n){let e,t,r,i,s,u,f,p=n[0].name+"",_,y,m,b;function x(I,j){return j&1&&(i=null),j&1&&(s=null),I[0].dir?Mu:(i==null&&(i=!!(I[0].name.endsWith(".glksave")||I[0].name.endsWith(".sav"))),i?Ou:(s==null&&(s=!!I[0].name.endsWith(".txt")),s?Wu:Iu))}let U=x(n,-1),E=U(n),T=n[1]&&Ea(n);return{c(){e=N("div"),t=N("button"),r=N("div"),E.c(),u=ae(),f=N("div"),_=we(p),y=ae(),T&&T.c(),k(r,"class","icon svelte-1wgzrj7"),k(r,"aria-hidden","true"),k(f,"class","name svelte-1wgzrj7"),k(t,"aria-selected",n[1]),k(t,"class","flat svelte-1wgzrj7"),k(t,"role","option"),k(e,"class","filelistitem svelte-1wgzrj7"),yt(e,"selected",n[1])},m(I,j){V(I,e,j),G(e,t),G(t,r),E.m(r,null),G(t,u),G(t,f),G(f,_),G(e,y),T&&T.m(e,null),m||(b=[fe(t,"click",n[2]),fe(t,"dblclick",ca(ua(n[4]))),fe(t,"keydown",n[6])],m=!0)},p(I,[j]){U!==(U=x(I,j))&&(E.d(1),E=U(I),E&&(E.c(),E.m(r,null))),j&1&&p!==(p=I[0].name+"")&&We(_,p),j&2&&k(t,"aria-selected",I[1]),I[1]?T?T.p(I,j):(T=Ea(I),T.c(),T.m(e,null)):T&&(T.d(1),T=null),j&2&&yt(e,"selected",I[1])},i:ye,o:ye,d(I){I&&Q(e),E.d(),T&&T.d(),m=!1,xe(b)}}}function Qu(n,e,t){let r=No(),{data:i}=e,{selected:s}=e,{selected_file:u}=e;function f(){t(9,u=i)}function p(){r("file_delete",i)}function _(){r("file_doubleclicked",i)}function y(){r("file_download",i)}function m(U){if(U.code==="ArrowDown"){let E=U.target.nextElementSibling;E&&(E.click(),E.focus())}if(U.code==="ArrowUp"){let E=U.target.previousElementSibling;E&&(E.click(),E.focus())}U.code==="Enter"&&(r("file_doubleclicked",i),U.preventDefault())}function b(){r("file_doubleclicked",i)}function x(){r("file_rename",i)}return n.$$set=U=>{"data"in U&&t(0,i=U.data),"selected"in U&&t(1,s=U.selected),"selected_file"in U&&t(9,u=U.selected_file)},[i,s,f,p,_,y,m,b,x,u]}var ns=class extends Ne{constructor(e){super(),ot(this,e,Qu,Nu,it,{data:0,selected:1,selected_file:9})}},Ua=ns;function Ca(n,e,t){let r=n.slice();return r[33]=e[t],r}function Ra(n){let e,t,r;function i(u){n[26](u)}let s={data:n[33],selected:n[33].full_path===n[3]?.full_path};return n[3]!==void 0&&(s.selected_file=n[3]),e=new Ua({props:s}),Xe.push(()=>Jo(e,"selected_file",i)),e.$on("file_delete",n[13]),e.$on("file_doubleclicked",n[14]),e.$on("file_download",n[15]),e.$on("file_rename",n[16]),{c(){sr(e.$$.fragment)},m(u,f){Tt(e,u,f),r=!0},p(u,f){let p={};f[0]&32&&(p.data=u[33]),f[0]&40&&(p.selected=u[33].full_path===u[3]?.full_path),!t&&f[0]&8&&(t=!0,p.selected_file=u[3],$o(()=>t=!1)),e.$set(p)},i(u){r||(Ue(e.$$.fragment,u),r=!0)},o(u){$e(e.$$.fragment,u),r=!1},d(u){It(e,u)}}}function Da(n){let e,t,r,i,s,u,f;return{c(){e=N("div"),t=N("label"),t.textContent="File name:",r=ae(),i=N("textarea"),k(t,"for","filename_input"),k(i,"id","filename_input"),k(i,"autocapitalize","off"),k(i,"rows","1"),k(i,"class","svelte-1wjxkp6"),k(e,"class","filename svelte-1wjxkp6")},m(p,_){V(p,e,_),G(e,t),G(e,r),G(e,i),u||(f=[fe(i,"keydown",n[17]),si(s=n[12].call(null,i))],u=!0)},p:ye,d(p){p&&Q(e),u=!1,xe(f)}}}function Ba(n){let e,t,r,i,s,u;function f(y,m){return y[6].label?ju:Vu}let p=f(n,[-1,-1]),_=p(n);return{c(){e=N("label"),e.textContent="File type:",t=ae(),r=N("select"),_.c(),i=N("option"),i.textContent="All files",k(e,"for","dialog_filter"),i.__value="*",nr(i,i.__value),k(r,"id","dialog_filter"),k(r,"class","svelte-1wjxkp6"),n[1]===void 0&&Dt(()=>n[27].call(r))},m(y,m){V(y,e,m),V(y,t,m),V(y,r,m),_.m(r,null),G(r,i),Lo(r,n[1],!0),s||(u=fe(r,"change",n[27]),s=!0)},p(y,m){p===(p=f(y,m))&&_?_.p(y,m):(_.d(1),_=p(y),_&&(_.c(),_.m(r,i))),m[0]&66&&Lo(r,y[1])},d(y){y&&(Q(e),Q(t),Q(r)),_.d(),s=!1,u()}}}function Vu(n){let e,t=n[6].extensions[0]+"",r,i,s;return{c(){e=N("option"),r=we(t),i=we(" file"),e.__value=s=n[6].extensions.join(),nr(e,e.__value)},m(u,f){V(u,e,f),G(e,r),G(e,i)},p(u,f){f[0]&64&&t!==(t=u[6].extensions[0]+"")&&We(r,t),f[0]&64&&s!==(s=u[6].extensions.join())&&(e.__value=s,nr(e,e.__value))},d(u){u&&Q(e)}}}function ju(n){let e,t=n[6].label+"",r,i;return{c(){e=N("option"),r=we(t),e.__value=i=n[6].extensions.join(),nr(e,e.__value)},m(s,u){V(s,e,u),G(e,r)},p(s,u){u[0]&64&&t!==(t=s[6].label+"")&&We(r,t),u[0]&64&&i!==(i=s[6].extensions.join())&&(e.__value=i,nr(e,e.__value))},d(s){s&&Q(e)}}}function Ta(n){let e;function t(s,u){return s[9]?Pu:$u}let i=t(n,[-1,-1])(n);return{c(){e=N("div"),i.c(),k(e,"id","storage_warning"),k(e,"class","svelte-1wjxkp6")},m(s,u){V(s,e,u),i.m(e,null)},p:ye,d(s){s&&Q(e),i.d()}}}function $u(n){let e;return{c(){e=we("Note: Files saved in this browser may be lost by clearing cookies, or depending on your browser settings.")},m(t,r){V(t,e,r)},d(t){t&&Q(e)}}}function Pu(n){let e;return{c(){e=we("Warning: Files saved in this browser will be lost if you don't visit again within a week.")},m(t,r){V(t,e,r)},d(t){t&&Q(e)}}}function zu(n){let e,t,r,i,s,u,f,p,_,y,m,b,x,U,E,T,I,j,ne,ke,me,ee,ie,ge,oe,be;function le(F){n[25](F)}let pe={};n[0]!==void 0&&(pe.cur_dir=n[0]),f=new Aa({props:pe}),Xe.push(()=>Jo(f,"cur_dir",le));let he=wt(n[5]),P=[];for(let F=0;F<he.length;F+=1)P[F]=Ra(Ca(n,he,F));let ce=F=>$e(P[F],1,1,()=>{P[F]=null}),se=n[2]&&Da(n),ue=n[6]&&Ba(n),z=n[2]&&Ta(n);return{c(){e=N("div"),t=N("div"),r=N("button"),r.textContent="Add file",i=ae(),s=N("button"),s.textContent="New Folder",u=ae(),sr(f.$$.fragment),_=ae(),y=N("div");for(let F=0;F<P.length;F+=1)P[F].c();m=ae(),se&&se.c(),b=ae(),x=N("div"),U=N("div"),ue&&ue.c(),E=ae(),T=N("div"),I=N("button"),I.textContent="Cancel",j=ae(),ne=N("button"),ke=we(n[7]),me=ae(),z&&z.c(),ee=ae(),ie=N("input"),k(t,"id","actions"),k(t,"class","svelte-1wjxkp6"),k(y,"id","filelist"),k(y,"role","listbox"),k(y,"class","svelte-1wjxkp6"),k(U,"id","filter"),k(U,"class","svelte-1wjxkp6"),k(I,"class","close"),k(ne,"class","submit"),k(x,"class","foot uirow"),k(ie,"id","add_file"),k(ie,"type","file"),ie.multiple=!0,k(ie,"class","svelte-1wjxkp6")},m(F,C){V(F,e,C),G(e,t),G(t,r),G(t,i),G(t,s),G(e,u),Tt(f,e,null),V(F,_,C),V(F,y,C);for(let Z=0;Z<P.length;Z+=1)P[Z]&&P[Z].m(y,null);V(F,m,C),se&&se.m(F,C),V(F,b,C),V(F,x,C),G(x,U),ue&&ue.m(U,null),G(x,E),G(x,T),G(T,I),G(T,j),G(T,ne),G(ne,ke),V(F,me,C),z&&z.m(F,C),V(F,ee,C),V(F,ie,C),n[28](ie),ge=!0,oe||(be=[fe(r,"click",n[10]),fe(s,"click",n[18]),fe(I,"click",n[11]),fe(ne,"click",n[19]),fe(ie,"change",n[20])],oe=!0)},p(F,C){let Z={};if(!p&&C[0]&1&&(p=!0,Z.cur_dir=F[0],$o(()=>p=!1)),f.$set(Z),C[0]&122920){he=wt(F[5]);let K;for(K=0;K<he.length;K+=1){let de=Ca(F,he,K);P[K]?(P[K].p(de,C),Ue(P[K],1)):(P[K]=Ra(de),P[K].c(),Ue(P[K],1),P[K].m(y,null))}for(Po(),K=he.length;K<P.length;K+=1)ce(K);zo()}F[2]?se?se.p(F,C):(se=Da(F),se.c(),se.m(b.parentNode,b)):se&&(se.d(1),se=null),F[6]?ue?ue.p(F,C):(ue=Ba(F),ue.c(),ue.m(U,null)):ue&&(ue.d(1),ue=null),(!ge||C[0]&128)&&We(ke,F[7]),F[2]?z?z.p(F,C):(z=Ta(F),z.c(),z.m(ee.parentNode,ee)):z&&(z.d(1),z=null)},i(F){if(!ge){Ue(f.$$.fragment,F);for(let C=0;C<he.length;C+=1)Ue(P[C]);ge=!0}},o(F){$e(f.$$.fragment,F),P=P.filter(Boolean);for(let C=0;C<P.length;C+=1)$e(P[C]);ge=!1},d(F){F&&(Q(e),Q(_),Q(y),Q(m),Q(b),Q(x),Q(me),Q(ee),Q(ie)),It(f),li(P,F),se&&se.d(F),ue&&ue.d(),z&&z.d(F),n[28](null),oe=!1,xe(be)}}}function Hu(n){let e,t,r={extra_class:"asyncglk_file_dialog "+(n[2]?"":"selecting"),fullscreen:!0,$$slots:{default:[zu]},$$scope:{ctx:n}};return e=new di({props:r}),n[29](e),{c(){sr(e.$$.fragment)},m(i,s){Tt(e,i,s),t=!0},p(i,s){let u={};s[0]&4&&(u.extra_class="asyncglk_file_dialog "+(i[2]?"":"selecting")),s[0]&495|s[1]&32&&(u.$$scope={dirty:s,ctx:i}),e.$set(u)},i(i){t||(Ue(e.$$.fragment,i),t=!0)},o(i){$e(e.$$.fragment,i),t=!1},d(i){n[29](null),It(e,i)}}}function Ju(n,e,t){let r,{controller:i}=e,{cur_dir:s="/usr"}=e,u=[],f="",p,_,{metadata:y={}}=e,m,b,x="",U,E=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);function T(C){t(21,y=C.metadata),C.filter?.extensions.join()!==_?.extensions.join()&&(f!=="*"&&t(1,f=C.filter?.extensions.join()??"*"),t(6,_=C.filter),_||t(1,f="*")),t(2,m=C.save),t(7,x=C.submit_label),t(3,b=void 0);let Z=r.open(C.title);return m&&p&&(p.focus(),t(24,p.value="",p)),Z.then(K=>typeof K=="string"?K:null)}function I(C,Z,K){let de={},Ee=C+"/",Me=Ee.length;for(let[Se,Ce]of Object.entries(K))if(Se.startsWith(Ee)){let Re=Se.substring(Me),De=Fe.parse(Re);De.dir?!De.dir.includes("/")&&!de[De.dir]&&(de[De.dir]={dir:!0,full_path:Ee+De.dir,name:De.dir}):de[De.base]={dir:!1,full_path:Se,meta:Ce,name:De.base}}return Object.values(de).filter(Se=>{if(Se.name.endsWith(".dir"))return!1;if(Se.dir||Z==="*")return!0;let Ce=Z.split(",");for(let Re of Ce)if(Se.name.endsWith(Re))return!0;return!1}).sort((Se,Ce)=>Se.dir!==Ce.dir?+Ce.dir-+Se.dir:Se.name.localeCompare(Ce.name))}async function j(C,Z,K,de){let Ee=new hi({target:document.body,props:{initial:de,message:K,mode:C,title:Z}}),Me=await Ee.open();return await Ee.$destroy(),Me}async function ne(C){for(let Z of u)if(C===Z.name)return!!await j(Zo,"Overwrite file",`Are you sure you want to overwrite ${C}?`);return!0}function ke(){U.click()}function me(){r.resolve(!1)}function ee(C){t(24,p=C),p.focus(),t(24,p.value="",p)}async function ie(C){let Z=C.detail;await j(Zo,"Delete file",`Are you sure you want to delete ${Z.dir?"the folder ":""}${Z.name}?`)&&i.delete(Z)}function ge(C){let Z=C.detail;Z.dir?t(0,s=Z.full_path):(t(24,p.value=Z.name,p),he())}function oe(C){let Z=C.detail;i.download(Z)}async function be(C){let Z=C.detail,K=Z.dir?"folder":"file",de=await j(Wt,`Rename ${K}`,`Enter new ${K} name`,Z.name);de&&await ne(de)&&i.rename(Z,de)}function le(C){C.code==="Enter"&&(he(),C.preventDefault())}async function pe(){let C=await j(Wt,"New folder","Enter new folder name");if(C){let Z=s+"/"+C;i.new_folder(Z)}}async function he(){if(m){let C=p.value.trim();await ne(C)&&r.resolve(C?s+"/"+C:!1)}else r.resolve(b?.full_path??!1)}async function P(){if(U.files){let C={},Z=!1;for(let K of U.files)await ne(K.name)&&(C[s+"/"+K.name]=K,Z=!0);Z&&i.upload(C)}t(8,U.value="",U)}function ce(C){s=C,t(0,s)}function se(C){b=C,t(3,b),t(0,s)}function ue(){f=pa(this),t(1,f),t(6,_)}function z(C){Xe[C?"unshift":"push"](()=>{U=C,t(8,U)})}function F(C){Xe[C?"unshift":"push"](()=>{r=C,t(4,r)})}return n.$$set=C=>{"controller"in C&&t(22,i=C.controller),"cur_dir"in C&&t(0,s=C.cur_dir),"metadata"in C&&t(21,y=C.metadata)},n.$$.update=()=>{n.$$.dirty[0]&1&&t(3,b=void 0),n.$$.dirty[0]&2097155&&t(5,u=I(s,f,y)),n.$$.dirty[0]&16777228&&m&&p&&b&&!b.dir&&t(24,p.value=b.name,p)},[s,f,m,b,r,u,_,x,U,E,ke,me,ee,ie,ge,oe,be,le,pe,he,P,y,i,T,p,ce,se,ue,z,F]}var is=class extends Ne{constructor(e){super(),ot(this,e,Ju,Hu,it,{controller:22,cur_dir:0,metadata:21,prompt:23},null,[-1,-1])}get prompt(){return this.$$.ctx[23]}},Ia=is;var tn=class{constructor(){this.async=!0;this.dirs={storyfile:"",system_cwd:"/",temp:"/tmp",working:"/usr"};this.providers=[]}async init(e){this.downloader=new mi(e);try{this.providers=[this.downloader,new en("/tmp",sessionStorage,this.dirs),new en("/",localStorage,this.dirs,!0)]}catch{this.providers=[this.downloader]}for(let[t,r]of this.providers.entries()){let i=this.providers[t+1];i&&(r.next=i),r.browseable&&(this.controller=new os(r))}}async download(e,t){let r=await this.downloader.download(e,t);return this.setup(r),r}get_dirs(){return this.dirs}async prompt(e,t){return this.controller?this.controller.prompt(e,t):(await _i(`Cannot ${t?"save":"open"}`,"LocalStorage is not currently supported in this browser. You should be able to enable it in your browser settings; it may be under a setting about cookies."),null)}set_storyfile_dir(e){return{storyfile:e}}async upload(e){let t=await this.downloader.upload(e);return this.setup(t),t}async delete(e){await this.providers[0].delete(e)}async exists(e){return!!await this.providers[0].exists(e)}async read(e){return this.providers[0].read(e)}async write(e){await this.providers[0].write(e)}setup(e){let t=Fe.parse(e);this.dirs.storyfile=t.dir,this.dirs.working="/usr/"+t.name.toLowerCase().trim(),this.controller?.update_working(this.dirs.working)}},os=class{constructor(e){this.metadata={};this.dialog=new Ia({target:document.body,props:{controller:this}}),this.provider=e}async prompt(e,t){let r=t?"Save":"Open",i=qu(e);return this.metadata=await this.provider.metadata(),this.dialog.prompt({filter:i,metadata:this.metadata,save:t,submit_label:r,title:`${r} a ${i?.title}`})}async delete(e){if(e.dir){let t=e.full_path+"/";for(let r of Object.keys(this.metadata))r.startsWith(t)&&(delete this.metadata[r],await this.provider.delete(r))}else await this.provider.delete(e.full_path),delete this.metadata[e.full_path];await this.update()}async download(e){let t=await this.provider.read(e.full_path);(0,Wa.saveAs)(new Blob([t]),e.name)}async new_folder(e){let t=Date.now(),r=e+"/.dir";await this.provider.write({[r]:new Uint8Array(0)}),this.metadata[r]={atime:t,mtime:t},this.dialog.$set({cur_dir:e,metadata:this.metadata})}async rename(e,t){let i=Fe.parse(e.full_path).dir+"/"+t;await this.provider.rename(e.dir,e.full_path,i),await this.update(!0)}async update(e=!1){e&&(this.metadata=await this.provider.metadata()),this.dialog.$set({metadata:this.metadata})}update_working(e){this.dialog.$set({cur_dir:e})}async upload(e){let t=Date.now(),r={};for(let[i,s]of Object.entries(e))r[i]=await Ko(s),this.metadata[i]={atime:t,mtime:t};await this.provider.write(r),await this.update()}};function qu(n){switch(n){case".glkdata":return{extensions:[".glkdata"],label:"Data file",title:"data file"};case".glksave":return{extensions:[".glksave",".sav"],label:"Save file",title:"savefile"};case".txt":return{extensions:[".txt"],label:"Transcript or log",title:"log"}}}function Pe(n,e){return $(`<${n}>`,{class:e})}var yi=class{constructor(e){this.context_element=e.context_element,this.errorcontent_id=e.errorcontent_id,this.errorpane_id=e.errorpane_id,this.gameport_id=e.gameport_id,this.loadingpane_id=e.loadingpane_id,this.prefix=e.prefix,this.windowport_id=e.windowport_id}create(e,t,r){return r??={},typeof r=="string"&&(r={class:r}),r.id=this.prefix+t,$(`<${e}>`,r)}gameport(){return $(`#${this.gameport_id}`,this.context_element)}id(e){return $(`#${this.prefix}${e}`,this.context_element)}windowport(){return $(`#${this.windowport_id}`,this.context_element)}};function vi(){let n=document.activeElement?.tagName;return n==="INPUT"||n==="TEXTAREA"}var et=/iPad|iPhone|iPod/.test(navigator.platform)||navigator.platform==="MacIntel"&&(navigator.maxTouchPoints??0)>1;function st(n){return{height:n.outerHeight(),width:n.outerWidth()}}function Yu(n,e){return e.buffercharheight!==n.buffercharheight||e.buffercharwidth!==n.buffercharwidth||e.gridcharheight!==n.gridcharheight||e.gridcharwidth!==n.gridcharwidth||e.height!==n.height||e.width!==n.width}var rn=class{constructor(e){this.height_with_keyboard=(visualViewport?.height||window.innerHeight)/2;this.on_gameport_resize=ri(async()=>{if(this.glkote.disabled||!this.glkote.inited()){this.on_gameport_resize();return}let e=Object.assign({},this.metrics);await this.measure(),Yu(this.metrics,e)&&this.glkote.send_event({type:"arrange"})},200,{leading:!1});this.on_visualViewport_resize=()=>{let e=visualViewport.height;vi()&&(this.height_with_keyboard=e),this.set_gameport_height(e)};this.glkote=e,this.metrics=e.current_metrics,document.readyState==="complete"?this.loaded=Promise.resolve():this.loaded=new Promise(t=>{window.addEventListener("load",t,{once:!0})}),window.ResizeObserver?(this.observer=new ResizeObserver(this.on_gameport_resize),this.observer.observe(this.glkote.dom.gameport()[0])):$(window).on("resize",this.on_gameport_resize),et&&(this.on_visualViewport_resize=ri(this.on_visualViewport_resize,700)),visualViewport&&$(visualViewport).on("resize",this.on_visualViewport_resize)}destroy(){this.observer?this.observer.disconnect():$(window).off("resize",this.on_gameport_resize),visualViewport&&$(visualViewport).off("resize",this.on_visualViewport_resize)}async measure(){let e=this.glkote.dom,t=e.gameport();if(!t.length)throw new Error(`Cannot find gameport element #${e.gameport_id}`);e.id("layouttestpane").remove();let r=e.create("div","layout_test_pane");r.text("This should not be visible");let i=$("<div>");Pe("span","Style_normal").text("12345678").appendTo(i);let s=Pe("div","WindowFrame BufferWindow"),u=Pe("div","BufferWindowInner").appendTo(s),f=i.clone().addClass("BufferLine").appendTo(u),p=i.clone().addClass("BufferLine").appendTo(u);Pe("span","InvisibleCursor").appendTo(p);let _=f.children("span");r.append(s);let y=Pe("div","WindowFrame GraphicsWindow"),m=$("<canvas>",{height:32,width:64}).appendTo(y);r.append(y);let b=Pe("div","WindowFrame GridWindow"),x=i.clone().addClass("GridLine").appendTo(b),U=i.clone().addClass("GridLine").appendTo(b),E=x.children("span");r.append(b),t.append(r),await this.loaded;let T=getComputedStyle(b[0]).getPropertyValue("--glkote-grid-mono-family").split(",")[0].replace(/"/g,"");await document.fonts.load(`14px ${T}`),this.metrics.height=t.height(),this.metrics.width=t.width();let I=st(s),j=st(_),ne=st(f),ke=st(p);this.metrics.buffercharheight=Math.max(1,p.position().top-f.position().top),this.metrics.buffercharwidth=Math.max(1,_.width()/8),this.metrics.buffermarginx=I.width-j.width,this.metrics.buffermarginy=I.height-(ne.height+ke.height);let me=st(y),ee=st(m);this.metrics.graphicsmarginx=me.width-ee.width,this.metrics.graphicsmarginy=me.height-ee.height;let ie=st(b),ge=st(E),oe=st(x),be=st(U);this.metrics.gridcharheight=Math.max(1,U.position().top-x.position().top),this.metrics.gridcharwidth=Math.max(1,E.width()/8),this.metrics.gridmarginx=ie.width-ge.width,this.metrics.gridmarginy=ie.height-(oe.height+be.height),r.remove()}set_gameport_height(e){gt()||(e||(e=this.height_with_keyboard),this.glkote.dom.gameport().outerHeight(e,!0),window.scrollTo(0,0),this.on_gameport_resize())}};var rc={},Oe,nn=null;function Ma(){return(nn===null||nn.byteLength===0)&&(nn=new Uint8Array(Oe.memory.buffer)),nn}var Ga=0;function Zu(n,e){let t=e(n.length*1,1)>>>0;return Ma().set(n,t/1),Ga=n.length,t}var Ot=null;function Oa(){return(Ot===null||Ot.buffer.detached===!0||Ot.buffer.detached===void 0&&Ot.buffer!==Oe.memory.buffer)&&(Ot=new DataView(Oe.memory.buffer)),Ot}function Ku(n,e){return n=n>>>0,Ma().subarray(n/1,n/1+e)}function La(n){try{let i=Oe.__wbindgen_add_to_stack_pointer(-16),s=Zu(n,Oe.__wbindgen_malloc),u=Ga;Oe.decode(i,s,u);var e=Oa().getInt32(i+4*0,!0),t=Oa().getInt32(i+4*1,!0),r=Ku(e,t).slice();return Oe.__wbindgen_free(e,t*1,1),r}finally{Oe.__wbindgen_add_to_stack_pointer(16)}}async function Xu(n,e){if(typeof Response=="function"&&n instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(n,e)}catch(r){if(n.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}let t=await n.arrayBuffer();return await WebAssembly.instantiate(t,e)}else{let t=await WebAssembly.instantiate(n,e);return t instanceof WebAssembly.Instance?{instance:t,module:n}:t}}function ec(){let n={};return n.wbg={},n}function tc(n,e){return Oe=n.exports,Na.__wbindgen_wasm_module=e,Ot=null,nn=null,Oe}async function Na(n){if(Oe!==void 0)return Oe;typeof n<"u"&&(Object.getPrototypeOf(n)===Object.prototype?{module_or_path:n}=n:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof n>"u"&&(n=new URL("glkaudio_bg.wasm",rc.url));let e=ec();(typeof n=="string"||typeof Request=="function"&&n instanceof Request||typeof URL=="function"&&n instanceof URL)&&(n=fetch(n));let{instance:t,module:r}=await Xu(await n,e);return tc(t,r)}var Qa=Na;var nc="SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU3LjU2LjEwMQAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU3LjY0AAAAAAAAAAAAAAAAJAUHAAAAAAAAAYYoRBqpAAAAAAD/+xDEAAPAAAGkAAAAIAAANIAAAARMQU1FMy45OS41VVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/7EMQpg8AAAaQAAAAgAAA0gAAABFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV",wi=class extends Map{constructor(e){super(),this.glkote=e,this.context=new AudioContext,this.prime()}async update(e){let t=[];for(let r of e){let{id:i,ops:s}=r;t.push(i),this.has(i)||this.set(i,new ss(this.glkote,this.context)),s&&this.get(i).do_ops(s)}for(let[r,i]of this)t.includes(r)||(i.delete(),this.delete(r))}async prime(){let e=this.context,t=this.context.createBufferSource(),r=await rt(nc);t.buffer=await e.decodeAudioData(r.buffer),t.connect(e.destination),t.start(),setTimeout(()=>{t.disconnect(),t.stop()},10)}},ss=class{constructor(e,t){this.buffer=null;this.notify=0;this.paused=!1;this.paused_time=0;this.repeats=0;this.snd=0;this.source=null;this.start_time=0;this.vol_timer=0;this.on_stop=()=>{this.stop(),this.repeats!==0?this.play():this.notify&&this.glkote.send_event({type:"sound",notify:this.notify,snd:this.snd})};this.context=t,this.glkote=e,this.gain=t.createGain(),this.gain.connect(t.destination)}delete(){this.stop(),this.vol_timer&&clearTimeout(this.vol_timer),this.gain.disconnect()}async do_ops(e){let t=this.context;for(let r of e)switch(r.op){case"pause":this.paused||(this.paused=!0,this.paused_time=t.currentTime-this.start_time,this.stop());break;case"play":{this.stop(),this.notify=r.notify??0,this.paused_time=0,this.repeats=r.repeats??1,this.snd=r.snd;let i=this.glkote.Blorb.get_chunk("sound",r.snd);if(!i)continue;try{this.buffer=await t.decodeAudioData(i.content.slice().buffer)}catch{Oe||await Qa({module_or_path:Io(this.glkote.options,"glkaudio_bg.wasm")});let s=La(i.content);this.buffer=await t.decodeAudioData(s.buffer)}this.paused||this.play();break}case"stop":this.stop(),this.buffer=null;break;case"unpause":this.paused&&(this.buffer?this.play():this.paused=!1);break;case"volume":{let i=t.currentTime,s=this.gain.gain,u=s.value;s.cancelScheduledValues(i),s.value=u,this.vol_timer&&clearTimeout(this.vol_timer);let f=()=>{this.glkote.send_event({type:"volume",notify:r.notify})};r.dur?(s.setValueAtTime(u||1e-4,i),s.exponentialRampToValueAtTime(r.vol||1e-4,i+r.dur/1e3),r.notify&&(this.vol_timer=setTimeout(f,r.dur))):(s.value=r.vol,r.notify&&f(),this.vol_timer=0);break}}}play(){let e=this.context.createBufferSource();this.source=e,e.addEventListener("ended",this.on_stop),e.buffer=this.buffer,e.connect(this.gain),this.start_time=this.context.currentTime-this.paused_time,e.start(0,this.paused_time),this.paused?(this.paused=!1,this.paused_time=0):this.repeats>0&&this.repeats--}stop(){let e=this.source;e&&(e.removeEventListener("ended",this.on_stop),e.stop(),e.disconnect(),this.source=null)}};function ic(n){if(Array.isArray(n)){for(var e=0,t=Array(n.length);e<n.length;e++)t[e]=n[e];return t}else return Array.from(n)}var ls=!1;typeof window<"u"&&(as={get passive(){ls=!0}},window.addEventListener("testPassive",null,as),window.removeEventListener("testPassive",null,as));var as,bi=typeof window<"u"&&window.navigator&&window.navigator.platform&&(/iP(ad|hone|od)/.test(window.navigator.platform)||window.navigator.platform==="MacIntel"&&window.navigator.maxTouchPoints>1),Gt=[],xi=!1,Va=-1,on=void 0,Mt=void 0,sn=void 0,ja=function(e){return Gt.some(function(t){return!!(t.options.allowTouchMove&&t.options.allowTouchMove(e))})},ki=function(e){var t=e||window.event;return ja(t.target)||t.touches.length>1?!0:(t.preventDefault&&t.preventDefault(),!1)},oc=function(e){if(sn===void 0){var t=!!e&&e.reserveScrollBarGap===!0,r=window.innerWidth-document.documentElement.clientWidth;if(t&&r>0){var i=parseInt(window.getComputedStyle(document.body).getPropertyValue("padding-right"),10);sn=document.body.style.paddingRight,document.body.style.paddingRight=i+r+"px"}}on===void 0&&(on=document.body.style.overflow,document.body.style.overflow="hidden")},sc=function(){sn!==void 0&&(document.body.style.paddingRight=sn,sn=void 0),on!==void 0&&(document.body.style.overflow=on,on=void 0)},ac=function(){return window.requestAnimationFrame(function(){if(Mt===void 0){Mt={position:document.body.style.position,top:document.body.style.top,left:document.body.style.left};var e=window,t=e.scrollY,r=e.scrollX,i=e.innerHeight;document.body.style.position="fixed",document.body.style.top=-t,document.body.style.left=-r,setTimeout(function(){return window.requestAnimationFrame(function(){var s=i-window.innerHeight;s&&t>=i&&(document.body.style.top=-(t+s))})},300)}})},lc=function(){if(Mt!==void 0){var e=-parseInt(document.body.style.top,10),t=-parseInt(document.body.style.left,10);document.body.style.position=Mt.position,document.body.style.top=Mt.top,document.body.style.left=Mt.left,window.scrollTo(t,e),Mt=void 0}},fc=function(e){return e?e.scrollHeight-e.scrollTop<=e.clientHeight:!1},uc=function(e,t){var r=e.targetTouches[0].clientY-Va;return ja(e.target)?!1:t&&t.scrollTop===0&&r>0||fc(t)&&r<0?ki(e):(e.stopPropagation(),!0)},$a=function(e,t){if(!e){console.error("disableBodyScroll unsuccessful - targetElement must be provided when calling disableBodyScroll on IOS devices.");return}if(!Gt.some(function(i){return i.targetElement===e})){var r={targetElement:e,options:t||{}};Gt=[].concat(ic(Gt),[r]),bi?ac():oc(t),bi&&(e.ontouchstart=function(i){i.targetTouches.length===1&&(Va=i.targetTouches[0].clientY)},e.ontouchmove=function(i){i.targetTouches.length===1&&uc(i,e)},xi||(document.addEventListener("touchmove",ki,ls?{passive:!1}:void 0),xi=!0))}};var Pa=function(e){if(!e){console.error("enableBodyScroll unsuccessful - targetElement must be provided when calling enableBodyScroll on IOS devices.");return}Gt=Gt.filter(function(t){return t.targetElement!==e}),bi&&(e.ontouchstart=null,e.ontouchmove=null,xi&&Gt.length===0&&(document.removeEventListener("touchmove",ki,ls?{passive:!1}:void 0),xi=!1)),bi?lc():sc()};var za=25,Si=class{constructor(e){this.history_index=0;this.is_line=!1;this.refocused=!1;this.set_gameport_height=Ct(e=>{this.window.manager.glkote.metrics_calculator.set_gameport_height(e?window.innerHeight:0)},50);this.window=e,this.el=$("<textarea>",{"aria-hidden":"true",autocapitalize:"off",class:"Input",data:{window:e},on:{blur:()=>this.onblur(),focus:()=>this.onfocus(),input:t=>this.oninput(t),keydown:t=>this.onkeydown(t),keypress:t=>this.onkeypress(t)},rows:1}).prop("disabled",!0).appendTo(e.frameel)}destroy(){this.el.remove()}onblur(){et&&!vi()&&this.set_gameport_height(!0)}onfocus(){this.window.type==="buffer"&&!gt()&&this.window.scroll_to_bottom(),et&&this.set_gameport_height(!1)}oninput(e){if(!this.window.inputs?.type)return this.el.trigger("blur"),!1;if(this.window.inputs.type==="char"){let t=e.target.value[0];return this.submit_char(t),t===" "&&this.el.trigger("blur").trigger("focus"),!1}}onkeydown(e){if(!this.window.inputs?.type)return this.el.trigger("blur"),!1;let t=e.which;if(t){if(this.is_line){if(t===Uo||t===Ro){let r=this.window.manager.history,i;return t===Uo&&this.history_index>0?(this.history_index--,i=1):t===Ro&&this.history_index<r.length&&(this.history_index++,i=1),i&&this.el.val(this.history_index===0?"":r[this.history_index-1]),!1}else if(this.window.inputs.terminators){let r=Fo[t];if(this.window.inputs.terminators.includes(r))return this.submit_line(e.target.value,r),!1}}else{let r=Fo[t];if(r)return this.submit_char(r),!1}e.stopPropagation()}}onkeypress(e){if(!this.window.inputs?.type)return this.el.trigger("blur"),!1;let t=e.which;if(t)if(this.is_line){if(t===Co)return this.submit_line(e.target.value),!1}else{let r=t===Co?"return":String.fromCharCode(t);return this.submit_char(r),!1}}refocus(){if(!(this.refocused||document.activeElement===this.el[0])){if(this.refocused=!0,this.window.type==="buffer"&&this.window.innerel.outerHeight()-this.window.updatescrolltop>this.window.height_above_keyboard){et&&this.set_gameport_height(!0);return}this.el[0].focus({preventScroll:!0})}}reset(){this.history_index=0,this.refocused=!1,this.el.attr({"aria-hidden":"true",class:"Input"}).css({"background-color":"",color:"",left:Hs,top:"",width:""}).val("");let e=this.window.type==="buffer"?this.window.innerel:this.window.frameel;this.el.parent().is(e)||this.el.appendTo(e)}submit_char(e){this.window.send_text_event({type:"char",value:e})}submit_line(e,t){let r=this.window.manager.history;e&&e!==r[0]&&(r.unshift(e),r.length>za&&(r.length=za)),this.window.send_text_event({type:"line",terminator:t,value:e})}update(){this.reset();let e=this.window.inputs;if(!(e.type!=="char"&&e.type!=="line")){if(this.is_line=e.type==="line",this.el.attr({"aria-hidden":"false",maxlength:this.is_line?e.maxlen:1}).prop("disabled",!1).val(e.initial||""),this.is_line){if(this.window.type==="graphics")throw new Error(`Cannot request line input in graphics window ${this.window.id}`);this.el.addClass("LineInput")}switch(this.window.type){case"buffer":(this.window.lastline||this.window.innerel).append(this.el);break;case"grid":{let t=this.window.metrics;this.el.css({left:e.xpos*t.gridcharwidth+t.gridmarginx/2,top:e.ypos*t.gridcharheight+t.gridmarginy/2,width:(e.maxlen||1)*t.gridcharwidth});break}}if(this.window.type!=="graphics"){let t=this.window.last_run_styles;if(t){let r=!!t.reverse;this.el.toggleClass("reverse",r),fs(t,r,this.el)}}}}};function Fi(){return window.getSelection()+""==""}var Ai=class{constructor(e){this.desired=!0;this.blorb=e.blorb,this.dom=e.dom,this.id=e.id,this.manager=e.manager,this.metrics=e.metrics,this.type=e.type,this.frameel=this.dom.create("div",`window${e.id}`,{class:`WindowFrame ${hc[this.type]} WindowRock_${e.rock}`,click:t=>this.onclick(t)}).appendTo(this.dom.windowport()),this.textinput=new Si(this)}destroy(e){this.textinput.destroy(),e?this.frameel.remove():this.inputs=void 0}measure_height(){}onclick(e){if(this.inputs?.type&&Fi())return this.textinput.el.trigger("focus"),!1}send_text_event(e){this.measure_height(),this.textinput.reset(),this.inputs.type=void 0,this.manager.active_window=this,e.window=this.id,this.manager.send_event(e)}};function fs(n,e,t){let r=Object.assign({},n);if(e){let i=r["background-color"],s=r.color;i?r.color=i:delete r.color,s?r["background-color"]=s:delete r["background-color"],delete r.reverse}t.css(r)}function cc(n){let e=[""],t=/\s/,r=!1;for(let i of n){let s=t.test(i);!s&&r&&e.unshift(""),e[0]+=i,r=s}return e.reverse(),e}var Ei=class extends Ai{constructor(e){super(e);let t=r=>this.onlink(r);this.frameel.on("click","a",function(){t(this)}),e.styles&&(this.styles=e.styles,this.add_stylehints())}add_stylehints(){let e=`#window${this.id}`,t={};if(this.styles){for(let[u,f]of Object.entries(this.styles)){let p=`${e} ${u}`.trim(),_=t[p]=Object.assign({},f);if(u){let y=_["background-color"],m=_.color;if(y||m){let b=t[`${p}.reverse`]={};y&&(b.color=y),m&&(b["background-color"]=m)}delete _.monospace,_.reverse&&(delete _["background-color"],delete _.color),delete _.reverse,Object.keys(_).length===0&&delete t[p]}}t[`${e} .Style_input`]&&(t[`${e} .LineInput`]=t[`${e} .Style_input`])}let r=t[`${e} .Style_normal`],i=this.bg||r?.["background-color"],s=this.fg||r?.color;(i||s)&&(t[e]||(t[e]={}),t[e]["background-color"]=i||`var(--glkote-${this.type}-bg)`,t[`${e}.reverse`]={"background-color":s||`var(--glkote-${this.type}-reverse-bg)`}),Object.keys(t).length&&(this.frameel.children("style").remove(),this.frameel.prepend(`<style>${Object.entries(t).map(u=>{let[f,p]=u;return`${f} {${Object.entries(p).map(_=>{let[y,m]=_;return`${y}: ${m}`}).join("; ")}}`}).join(`
`)}</style>`))}create_text_run(e,t){let r=e.style,i=e.css_styles?.monospace??this.styles?.[`.Style_${r}`]?.monospace,s="";typeof i<"u"&&(r==="preformatted"?i||(s=" proportional"):i&&(s=" monospace"));let u=e.css_styles?.reverse??this.styles?.[`.Style_${r}`]?.reverse,f=Pe("span",`Style_${r}${u?" reverse":""}${s}`);e.css_styles&&fs(e.css_styles,!!u,f),typeof t>"u"&&(t=!!i||r==="preformatted");let p=t?$(cc(e.text).map(_=>f.clone().text(_)[0])):f.text(e.text);return e.hyperlink?$("<a>",{data:{glklink:e.hyperlink},href:"#"}).append(p):p}onlink(e){let t=$(e).data("glklink");if(t)return this.inputs?.hyperlink&&this.manager.send_event({type:"hyperlink",value:t,window:this.id}),!1}refresh_styles(e,t){let r;typeof e<"u"&&e!==this.bg&&(this.bg=e,r=1),typeof t<"u"&&t!==this.fg&&(this.fg=t,r=1),r&&this.add_stylehints()}},dc={inlinecenter:"ImageInlineCenter",inlinedown:"ImageInlineDown",inlineup:"ImageInlineUp",marginleft:"ImageMarginLeft",marginright:"ImageMarginRight"},us=class extends Ei{constructor(t){super(t);this.type="buffer";this.is_scrolled_down=!0;this.updatescrolltop=0;this.onscroll=()=>{let t=this.frameel[0];this.is_scrolled_down=t.scrollHeight-t.scrollTop-t.clientHeight<1};this.frameel.attr({"aria-live":"polite",role:"log",tabindex:-1}).on("scroll",this.onscroll),et&&$a(this.frameel[0]),this.innerel=Pe("div","BufferWindowInner").append(this.textinput.el).appendTo(this.frameel),this.height_above_keyboard=this.frameel.height()}destroy(t){et&&Pa(this.frameel[0]),super.destroy(t)}measure_height(){this.height_above_keyboard=this.frameel.height()}onclick(t){if(this.inputs?.type&&Fi()){if(this.lastline&&this.height_above_keyboard){let r=this.lastline[0].getBoundingClientRect();if(r.bottom<0||r.top>document.documentElement.clientHeight)return!1}return this.textinput.el.trigger("focus"),!1}}scroll_to_bottom(t){(!t||this.is_scrolled_down)&&(this.frameel.scrollTop(this.innerel.height()),this.is_scrolled_down=!0)}update(t){if(t.clear&&(this.textinput.reset(),this.innerel.children(".BufferLine").remove(),this.is_scrolled_down=!0,this.lastline=void 0,this.last_run_styles=void 0,this.refresh_styles(t.bg,t.fg)),!t.text)return;this.frameel.attr("aria-busy","true"),this.updatescrolltop=Math.max(0,(this.lastline?.position().top||0)-20);let r=0;for(;r<t.text.length;){let i=t.text[r++],s=i.content,u,f;if(i.append&&this.lastline)u=this.lastline,f=1;else if(u=Pe("div","BufferLine"),this.innerel.append(u),this.lastline=u,!s?.length){u.addClass("BlankPara"),u.append(Pe("span","BlankLineSpace").text(ni));continue}if(i.flowbreak&&u.addClass("FlowBreak"),!!s?.length)for(let p=0;p<s.length;p++){let _,y=s[p];if(typeof y=="string")_={style:s[p++],text:s[p]};else if("special"in y&&y.special==="image"){let m=$("<img>",{alt:y.alttext||`Image ${y.image}`,class:dc[y.alignment||"inlineup"],height:y.height,src:this.blorb&&this.blorb.get_image_url(y.image)||y.url,width:y.width});if(y.hyperlink){$("<a>",{data:{glklink:y.hyperlink},href:"#"}).append(m).appendTo(u);continue}u.append(m);continue}else _=y;f||(f=1,u.addClass(`Style_${_.style}_par`)),u.append(this.create_text_run(_,r===t.text.length?!0:void 0)),this.last_run_styles=_.css_styles}}gt()||this.frameel.scrollTop(this.updatescrolltop),this.frameel.attr("aria-busy","false")}},cs=class extends Ai{constructor(t){super(t);this.type="graphics";this.fillcolour="";this.framequeue=[];this.height=0;this.image_cache=new Map;this.width=0;this.clear_cache=Ct(()=>{this.image_cache.clear()},5e3);this.canvas=this.dom.create("canvas",`win${t.id}_canvas`,{data:{window:this}}),this.frameel.append(this.canvas),this.manager.canvasResizeObserver?.observe(this.canvas[0]),this.buffer=this.dom.create("canvas",`win${t.id}_buffer`)}decode_image(t,r){let i=new Image;return i.src=r,i.decode().then(()=>{this.image_cache.set(t,i)}).catch(()=>{})}destroy(t){this.manager.canvasResizeObserver?.unobserve(this.canvas[0]),super.destroy(t)}onclick(t){return this.inputs?.mouse&&t.button===0?(this.inputs.mouse=!1,this.manager.send_event({type:"mouse",window:this.id,x:Math.floor(t.offsetX-this.metrics.graphicsmarginx/2),y:Math.floor(t.offsetY-this.metrics.graphicsmarginy/2)}),!1):super.onclick(t)}set_dimensions(t,r){this.canvas.css({height:t,width:r}),this.height=t,this.width=r;let i=devicePixelRatio;t=t*i,r=r*i,this.buffer.attr({height:t,width:r}),this.canvas.attr({height:t,width:r})}async update(){let t=this.buffer[0].getContext("2d");for(let r=0;r<this.framequeue.length;r++){let i=this.framequeue[r];if(!this.height||!this.width)break;if(!i.length)continue;let s=[];for(let f of i)if(f.special==="image"){let p=f.url||f.image;if(this.image_cache.has(p))continue;let _=f.url||this.blorb&&this.blorb.get_image_url(f.image);_&&s.push(this.decode_image(p,_))}await Promise.all(s);let u=devicePixelRatio;for(let f of i)switch(f.special){case"fill":t.fillStyle=f.color||this.fillcolour,Number.isFinite(f.x)?t.fillRect(f.x*u,f.y*u,f.width*u,f.height*u):t.fillRect(0,0,parseInt(this.buffer.attr("width")),parseInt(this.buffer.attr("height")));break;case"image":{let p=this.image_cache.get(f.url||f.image);p&&t.drawImage(p,f.x*u,f.y*u,f.width*u,f.height*u);break}case"setcolor":this.fillcolour=f.color;break}}this.height&&this.width&&this.canvas[0].getContext("2d").drawImage(this.buffer[0],0,0),this.framequeue.length=0,this.clear_cache()}},ds=class extends Ei{constructor(t){super(t);this.type="grid";this.height=0;this.lines=[];this.width=0;this.frameel.attr({"aria-atomic":"true","aria-live":"off",role:"status"})}onclick(t){return this.inputs?.mouse&&t.button===0&&Fi()?(this.inputs.mouse=!1,this.manager.send_event({type:"mouse",window:this.id,x:Math.floor((t.offsetX-this.metrics.gridmarginx/2)/this.metrics.gridcharwidth),y:Math.floor((t.offsetY-this.metrics.gridmarginy/2)/this.metrics.gridcharheight)}),!1):super.onclick(t)}update(t){t.clear&&(this.last_run_styles=void 0,this.refresh_styles(t.bg,t.fg)),this.frameel.attr("aria-busy","true");for(let r of t.lines){let i=this.lines[r.line];if(!i.length)throw new Error(`Got content for nonexistent line ${r.line} of window ${this.id}`);let s=r.content;if(!s||!s.length)i.text(ni);else{i.empty();for(let u=0;u<s.length;u++){let f;typeof s[u]=="string"?f={style:s[u++],text:s[u]}:f=s[u],i.append(this.create_text_run(f,!1)),this.last_run_styles=f.css_styles}}}this.frameel.toggleClass("reverse",$(`#window${this.id} span:not(.reverse)`).length===0).attr({"aria-busy":"false","aria-live":this.lines.length>3?"polite":"off"})}},pc={buffer:us,graphics:cs,grid:ds},hc={buffer:"BufferWindow",graphics:"GraphicsWindow",grid:"GridWindow"},an=class extends Map{constructor(t){super();this.history=[];this.onkeydown=t=>{if(!this.glkote.disabled&&t.target.nodeName!=="input"&&!(t.target.nodeName==="div"&&$(t.target).is(".BufferWindow:focus"))){let r=[...this.values()],i=r.filter(s=>s.inputs?.type)[0]||r.filter(s=>s.type==="buffer")[0];i&&(i.frameel.trigger("click"),i.textinput.el.is(":focus")?i.textinput.el.trigger(t):i.type==="buffer"&&i.frameel.trigger("focus"))}};if(this.dom=t.dom,this.glkote=t,this.metrics=t.current_metrics,window.ResizeObserver){let r=new ResizeObserver(i=>{typeof i?.[0].devicePixelContentBoxSize?.[0].blockSize<"u"&&(this.canvasResizeObserver=new ResizeObserver(s=>this.oncanvasresize(s))),r.disconnect()});r.observe(document.body)}this.send_event=r=>t.send_event(r),$(document).on("keydown",this.onkeydown),this.dom.gameport().on("click",()=>this.onclick())}destroy(){for(let t of this.values())t.destroy(!1),this.delete(t.id);$(document).off("keydown",this.onkeydown)}cancel_inputs(t){let r={};for(let i of t)r[i.id]=i;for(let i of this.values())!r[i.id]&&i.inputs&&(i.textinput.el.is(":focus")&&(this.active_window=i),i.textinput.el.prop("disabled",!0),delete i.inputs)}oncanvasresize(t){for(let r of t){let i=r.devicePixelContentBoxSize[0],s=i.blockSize,u=i.inlineSize,f=$(r.target).data("window");f.buffer.attr({height:s,width:u}),f.canvas.attr({height:s,width:u})}this.send_event({type:"redraw"})}onclick(){if(!this.glkote.disabled&&Fi()){for(let t of this.values())if(t.inputs?.type){t.frameel.trigger("click");break}}}update(t){for(let i of this.values())i.desired=!1;for(let i of t){let s=i.id,u=i.type,f=this.get(s);if(!f)f=new pc[u]({blorb:this.blorb,dom:this.dom,id:s,manager:this,metrics:this.metrics,rock:i.rock,styles:i.styles,type:u}),this.set(s,f);else if(f.type!==u)throw new Error(`Window ${s} was created with type ${f.type}, but now is described as type ${u}`);if(f.desired=!0,f.type==="graphics"&&(f.height!==i.graphheight||f.width!==i.graphwidth)&&f.set_dimensions(i.graphheight,i.graphwidth),f.type==="grid"){if(i.gridheight>f.height)for(let p=f.height;p<i.gridheight;p++){let _=this.dom.create("div",`win${f.id}_ln${p}`,"GridLine");_.append(ni),f.frameel.append(_),f.lines[p]=_}if(i.gridheight<f.height)for(let p=i.gridheight;p<f.height;p++)this.dom.id(`win${f.id}_ln${p}`).remove();f.height=i.gridheight,f.lines.length=f.height,f.width=i.gridwidth}f.frameel.css({height:i.height,left:i.left,top:i.top,width:i.width}).toggleClass("hidden",!!i.hidden),f.type==="buffer"&&f.scroll_to_bottom(!0)}let r=[];for(let i of this.values())i.desired||r.push(i);for(let i of r)i.destroy(!0),this.delete(i.id)}update_content(t){for(let r of t){let i=this.get(r.id);if(!i)throw new Error(`Got content update for window ${r.id}, which does not exist`);switch(i.type){case"buffer":i.update(r);break;case"graphics":i.framequeue.push(r.draw),i.framequeue.length===1&&i.update();break;case"grid":i.update(r);break}}}update_inputs(t){for(let r of t){let i=this.get(r.id);if(!i)throw new Error(`Got input update for window ${r.id}, which does not exist`);let s=i.inputs?.gen;i.inputs=r,r.type&&r.gen!==s&&i.textinput.update()}this.active_window&&(this.has(this.active_window.id)&&this.active_window.inputs?.type?this.active_window.textinput.refocus():[...this.values()].filter(r=>r.inputs?.type)[0]?.textinput.refocus())}};var ln=class{constructor(e,t){this.enabled=!1;this.handler=e=>this.web_handler(e);this.label="";this.session=Date.now()+Math.ceil(Math.random()*1e4).toString(16);this.url="";this.windows=t,e.recording_handler&&(this.enabled=!0,this.handler=e.recording_handler,this.url="(custom handler)"),e.recording_url&&(this.enabled=!0,this.url=e.recording_url),this.label=e.recording_label??"",this.enabled&&console.log(`Transcript recording active: session ${this.session} "${this.label}", destination ${this.url}`)}record_event(e){this.event=e,this.timestamp=Date.now()}record_update(e){if(!e.content)return;let t=this.event,r=t.type,i="";if(r==="char"||r==="line")i=t.value;else if(!(!r||r==="external"||r==="init"||r==="specialresponse"))return;let s="";for(let u of e.content){let f=this.windows.get(u.id);if(!f||f.type!=="buffer")continue;let p=u.text||[];for(let _ of p){_.append||(s+=`
`);let y=_.content;if(y?.length)for(let m=0;m<y.length;m++){let b=y[m];typeof b=="string"?s+=y[++m]:"text"in b&&(s+=b.text)}}}this.handler({format:"simple",input:i,label:this.label,output:s,outtimestamp:Date.now(),sessionId:this.session,timestamp:this.timestamp})}async web_handler(e){try{let t=await fetch(this.url,{body:JSON.stringify(e),headers:{"Content-Type":"application/json"},method:"POST"});if(!t.ok)throw new Error(`Could not submit transcript update, got ${t.status}`)}catch(t){this.enabled=!1,console.log(`Transcript recording failed; disabling. Error: ${t}`)}}};var lr=class extends Kr{constructor(){super();this.dom=new yi({context_element:void 0,errorcontent_id:"errorcontent",errorpane_id:"errorpane",gameport_id:"gameport",loadingpane_id:"loadingpane",prefix:"",windowport_id:"windowport"});this.showing_error=!1;this.showing_loading=!0;this.metrics_calculator=new rn(this),this.windows=new an(this)}async init(t){try{if(!t)throw new Error("no options provided");if(typeof jQuery>"u")throw new Error("jQuery is not loaded");t.dom_prefix&&(this.dom.prefix=t.dom_prefix),t.errorcontent&&(this.dom.errorcontent_id=t.errorcontent),t.errorpane&&(this.dom.errorpane_id=t.errorpane),t.gameport&&(this.dom.gameport_id=t.gameport),t.loadingpane&&(this.dom.loadingpane_id=t.loadingpane),t.windowport&&(this.dom.windowport_id=t.windowport),t.Blorb&&(this.windows.blorb=t.Blorb);let r=this.dom.windowport();if(!r.length)throw new Error(`Cannot find windowport element #${this.dom.windowport_id}`);r.empty();let i="initial-scale=1,interactive-widget=resizes-content,minimum-scale=1,width=device-width";if(et&&(i+=",maximum-scale=1"),document.head.querySelector('meta[name="viewport"]').content=i,await this.metrics_calculator.measure(),t.recording_url||t.recording_handler)if(t.recording_format&&t.recording_format!=="simple")console.warn('GlkOte: only the "simple" recording_format is supported');else{let s=new URLSearchParams(document.location.search).get("feedback"),u=t.recording_cookie||"transcript_recording_opt_out";s&&s!=="1"||document.cookie.includes(`${u}=1`)?console.log("User has opted out of transcript recording."):this.transcript_recorder=new ln(t,this.windows)}return typeof AudioContext<"u"&&(this.schannels=new wi(this)),super.init(t)}catch(r){this.error(r)}}autorestore(t){Array.isArray(t.history)&&(this.windows.history=t.history);for(let r of this.windows.values())r.type==="buffer"&&r.scroll_to_bottom();if(t.graphics_bg)for(let[r,i]of t.graphics_bg)this.windows.get(r).fillcolour=i;t.transcript_recorder_session&&this.transcript_recorder&&(this.transcript_recorder.session=t.transcript_recorder_session,console.log(`Resuming autosaved transcript recording session: ${t.transcript_recorder_session}`)),setTimeout(()=>this.send_event({type:"arrange"}),0)}cancel_inputs(t){this.windows.cancel_inputs(t)}capabilities(){let t=["garglktext","graphics","graphicswin","hyperlinks","timer"];return typeof AudioContext<"u"&&t.push("sounds"),t}disable(t){for(let r of this.windows.values())r.textinput.el.prop("disabled",t||!r.inputs?.type);this.disabled=t}embellish_error(){if(typeof $>"u")return;let t=$(`#${this.dom.errorpane_id}`);if(t.find("#errorclose").length||$("<button>",{"aria-label":"Close",click:()=>(t.hide(),!1),id:"errorclose",text:"\u2716",type:"button"}).appendTo(t),this.autorestoring&&!this.Dialog?.async&&this.Dialog?.autosave_clear){let r=$("<a>",{click:async()=>{this.Dialog.async||await this.Dialog.autosave_clear(),location.reload()},text:"Clear autosave and restart"});$("<div>").append(r).appendTo(t)}}error(t){t??="???";let r;typeof t=="string"?(r=t,t=new Error(t)):r=t.toString();let i=document.getElementById(this.dom.errorcontent_id);if(!i)throw new Error(r);i.innerHTML=r;let s=document.getElementById(this.dom.errorpane_id);s.className==="WarningPane"&&(s.className=""),this.embellish_error(),s.style.display="",this.showing_error=!0,this.hide_loading(),console.error(t)}exit(){this.metrics_calculator.destroy(),this.windows.destroy()}getdomcontext(){return this.dom.context_element}getdomid(t){switch(t){case"errorcontent":return this.dom.errorcontent_id;case"errorpane":return this.dom.errorpane_id;case"gameport":return this.dom.gameport_id;case"loadingpane":return this.dom.loadingpane_id;case"windowport":return this.dom.windowport_id;default:return t}}hide_loading(){if(!this.showing_loading)return;this.showing_loading=!1;let t=document.getElementById(this.dom.loadingpane_id);t&&(t.style.display="none")}save_allstate(){let t=[];for(let r of this.windows.values())r.type==="graphics"&&t.push([r.id,r.fillcolour]);return{graphics_bg:t,history:this.windows.history,transcript_recorder_session:this.transcript_recorder?.session}}send_event(t){if(t.type!=="init"&&t.type!=="refresh"&&t.type!=="specialresponse"){for(let r of this.windows.values())if(r.inputs?.type){let i=r.textinput.el.val();i&&(t.partial||(t.partial={}),t.partial[r.id]=i)}}this.transcript_recorder?.enabled&&this.transcript_recorder.record_event(t),super.send_event(t)}setdomcontext(t){this.dom.context_element=t}set_page_bg(t){$("body").css("background-color",t)}update(t){this.showing_loading&&this.hide_loading(),super.update(t),this.transcript_recorder?.enabled&&t.type==="update"&&!t.autorestore&&this.transcript_recorder.record_update(t)}update_content(t){this.windows.update_content(t)}update_inputs(t){this.windows.update_inputs(t)}update_schannels(t){this.schannels?.update(t)}update_windows(t){this.windows.update(t)}warning(t){if(this.showing_error)return;let r=$(`#${this.dom.errorpane_id}`);if(!t){r.hide();return}let i=document.getElementById(this.dom.errorcontent_id);if(!i){console.warn(t);return}i.innerHTML=t,this.embellish_error(),r.addClass("WarningPane"),r.show(),this.hide_loading()}};var ps={},_c=(()=>{var n=ps.url;return async function(e={}){var t,r=e,i,s,u=new Promise((o,l)=>{i=o,s=l}),f=typeof WorkerGlobalScope<"u";if(0)var p;let _,y,m,b=()=>{};r.start=function(o){if(_=o.Dialog,!_.async)throw new Error("Emglken requires an async Dialog library");y=o.GlkOte,o.accept=x,_s(o.arguments),y.init(o)};function x(o){m&&console.warn("Already have GlkOte event when next event arrives"),m=o,b()}r.locateFile=function(o){try{return new URL(o,ps.url).href}catch{return o}};var U=Object.assign({},r),E=[],T="./this.program",I=(o,l)=>{throw l},j="";function ne(o){return r.locateFile?r.locateFile(o,j):j+o}var ke,me;if(0)var ee,ie;else f?j=self.location.href:typeof document<"u"&&document.currentScript&&(j=document.currentScript.src),n&&(j=n),j.startsWith("blob:")?j="":j=j.substr(0,j.replace(/[?#].*/,"").lastIndexOf("/")+1),ke=async o=>{var l=await fetch(o,{credentials:"same-origin"});if(l.ok)return l.arrayBuffer();throw new Error(l.status+" : "+l.url)};var ge=console.log.bind(console),oe=console.error.bind(console);Object.assign(r,U),U=null;var be=r.wasmBinary,le,pe=!1,he,P,ce,se,ue,z,F,C,Z;function K(){var o=le.buffer;P=new Int8Array(o),se=new Int16Array(o),ce=new Uint8Array(o),ue=new Uint16Array(o),z=new Int32Array(o),F=new Uint32Array(o),C=new Float32Array(o),Z=new Float64Array(o)}var de=[],Ee=[],Me=[],dt=[],Se=[],Ce=!1,Re=!1;function De(){Je(de)}function Lt(){Ce=!0,Je(Ee)}function Nt(){Je(Me)}function Qt(){Rr(),Je(dt),J(),Re=!0}function Ui(){Je(Se)}function Ci(o){Ee.unshift(o)}var ze=0,He=null;function Ri(o){ze++}function Di(o){if(ze--,ze==0&&He){var l=He;He=null,l()}}function Qe(o){o="Aborted("+o+")",oe(o),pe=!0,o+=". Build with -sASSERTIONS for more info.";var l=new WebAssembly.RuntimeError(o);throw s(l),l}var Bi="data:application/octet-stream;base64,",fr=o=>o.startsWith(Bi),Za=o=>o.startsWith("file://");function Ti(){if(r.locateFile){var o="bocfel.wasm";return fr(o)?o:ne(o)}return new URL("bocfel.wasm",ps.url).href}var bt;function Ii(o){if(o==bt&&be)return new Uint8Array(be);if(me)return me(o);throw"both async and sync fetching of the wasm failed"}async function Wi(o){if(!be)try{var l=await ke(o);return new Uint8Array(l)}catch{}return Ii(o)}async function Oi(o,l){try{var d=await Wi(o),g=await WebAssembly.instantiate(d,l);return g}catch(v){oe(`failed to asynchronously prepare wasm: ${v}`),Qe(v)}}async function Mi(o,l,d){if(!o&&typeof WebAssembly.instantiateStreaming=="function"&&!fr(l)&&typeof fetch=="function")try{var g=fetch(l,{credentials:"same-origin"}),v=await WebAssembly.instantiateStreaming(g,d);return v}catch(A){oe(`wasm streaming compile failed: ${A}`),oe("falling back to ArrayBuffer instantiation")}return Oi(l,d)}function Gi(){return{a:Dn}}async function Li(){function o(v,A){return M=v.exports,M=W.instrumentWasmExports(M),le=M.pa,K(),ve=M.va,Ci(M.qa),Di("wasm-instantiate"),M}Ri("wasm-instantiate");function l(v){o(v.instance)}var d=Gi();bt??=Ti();try{var g=await Mi(be,bt,d);return l(g),g}catch(v){s(v);return}}var Ge,xt;class ur{name="ExitStatus";constructor(l){this.message=`Program terminated with exit(${l})`,this.status=l}}var Je=o=>{for(;o.length>0;)o.shift()(r)},q=o=>Tr(o),Y=()=>Wr(),Ni=(o,l)=>(d=>Kt(o,d))(l),qe=[],kt=0,Qi=o=>{var l=new cr(o);return l.get_caught()||(l.set_caught(!0),kt--),l.set_rethrown(!1),qe.push(l),Mr(o),Lr(o)},Be=0,Vi=()=>{re(0,0);var o=qe.pop();Or(o.excPtr),Be=0};class cr{constructor(l){this.excPtr=l,this.ptr=l-24}set_type(l){F[this.ptr+4>>2]=l}get_type(){return F[this.ptr+4>>2]}set_destructor(l){F[this.ptr+8>>2]=l}get_destructor(){return F[this.ptr+8>>2]}set_caught(l){l=l?1:0,P[this.ptr+12]=l}get_caught(){return P[this.ptr+12]!=0}set_rethrown(l){l=l?1:0,P[this.ptr+13]=l}get_rethrown(){return P[this.ptr+13]!=0}init(l,d){this.set_adjusted_ptr(0),this.set_type(l),this.set_destructor(d)}set_adjusted_ptr(l){F[this.ptr+16>>2]=l}get_adjusted_ptr(){return F[this.ptr+16>>2]}}var ji=o=>{throw Be||(Be=o),Be},Vt=o=>Br(o),pt=o=>{var l=Be;if(!l)return Vt(0),0;var d=new cr(l);d.set_adjusted_ptr(l);var g=d.get_type();if(!g)return Vt(0),l;for(var v of o){if(v===0||v===g)break;var A=d.ptr+16;if(Gr(v,g,A))return Vt(v),l}return Vt(g),l},$i=()=>pt([]),Pi=o=>pt([o]),zi=(o,l)=>pt([o,l]),Hi=(o,l,d)=>pt([o,l,d]),Ji=(o,l,d,g)=>pt([o,l,d,g]),qi=(o,l,d,g,v)=>pt([o,l,d,g,v]),fn=()=>{var o=qe.pop();o||Qe("no exception to throw");var l=o.excPtr;throw o.get_rethrown()||(qe.push(o),o.set_rethrown(!0),o.set_caught(!1),kt++),Be=l,Be},ht=(o,l,d)=>{var g=new cr(o);throw g.init(l,d),Be=o,kt++,Be},Yi=()=>kt,un=new TextDecoder,at=(o,l)=>{if(!o)return"";for(var d=o+l,g=o;!(g>=d)&&ce[g];)++g;return un.decode(ce.subarray(o,g))},dr={varargs:void 0,getStr(o){var l=at(o);return l}};function Zi(o,l,d){return dr.varargs=d,0}var jt=o=>{for(var l=0,d=0;d<o.length;++d){var g=o.charCodeAt(d);g<=127?l++:g<=2047?l+=2:g>=55296&&g<=57343?(l+=4,++d):l+=3}return l},Ki=(o,l,d,g)=>{if(!(g>0))return 0;for(var v=d,A=d+g-1,B=0;B<o.length;++B){var D=o.charCodeAt(B);if(D>=55296&&D<=57343){var X=o.charCodeAt(++B);D=65536+((D&1023)<<10)|X&1023}if(D<=127){if(d>=A)break;l[d++]=D}else if(D<=2047){if(d+1>=A)break;l[d++]=192|D>>6,l[d++]=128|D&63}else if(D<=65535){if(d+2>=A)break;l[d++]=224|D>>12,l[d++]=128|D>>6&63,l[d++]=128|D&63}else{if(d+3>=A)break;l[d++]=240|D>>18,l[d++]=128|D>>12&63,l[d++]=128|D>>6&63,l[d++]=128|D&63}}return l[d]=0,d-v},Ye=(o,l,d)=>Ki(o,ce,l,d),pr=(o,l)=>{};function hr(o,l,d){return dr.varargs=d,0}function cn(o,l,d,g){dr.varargs=g}var dn=()=>Qe(""),pn=(o,l,d)=>ce.copyWithin(o,l,l+d),$t=0,hn=()=>{$t=0},_n=o=>o%4===0&&(o%100!==0||o%400===0),Xi=[0,31,60,91,121,152,182,213,244,274,305,335],mn=[0,31,59,90,120,151,181,212,243,273,304,334],eo=o=>{var l=_n(o.getFullYear()),d=l?Xi:mn,g=d[o.getMonth()]+o.getDate()-1;return g},_r=(o,l)=>l+2097152>>>0<4194305-!!o?(o>>>0)+l*4294967296:NaN;function gn(o,l,d){var g=_r(o,l),v=new Date(g*1e3);z[d>>2]=v.getSeconds(),z[d+4>>2]=v.getMinutes(),z[d+8>>2]=v.getHours(),z[d+12>>2]=v.getDate(),z[d+16>>2]=v.getMonth(),z[d+20>>2]=v.getFullYear()-1900,z[d+24>>2]=v.getDay();var A=eo(v)|0;z[d+28>>2]=A,z[d+36>>2]=-(v.getTimezoneOffset()*60);var B=new Date(v.getFullYear(),0,1),D=new Date(v.getFullYear(),6,1).getTimezoneOffset(),X=B.getTimezoneOffset(),_e=(D!=X&&v.getTimezoneOffset()==Math.min(X,D))|0;z[d+32>>2]=_e}var St={},Pt=o=>{if(o instanceof ur||o=="unwind")return he;I(1,o)},zt=()=>$t>0,mr=o=>{he=o,zt()||(pe=!0),I(o,new ur(o))},gr=(o,l)=>{he=o,zt()||Qt(),mr(o)},yr=gr,yn=()=>{if(!Re&&!zt())try{yr(he)}catch(o){Pt(o)}},vn=o=>{if(!(Re||pe))try{o(),yn()}catch(l){Pt(l)}},wn=()=>performance.now(),bn=(o,l)=>{if(St[o]&&(clearTimeout(St[o].id),delete St[o]),!l)return 0;var d=setTimeout(()=>{delete St[o],vn(()=>Dr(o,wn()))},l);return St[o]={id:d,timeout_ms:l},0},to=(o,l,d,g)=>{var v=new Date().getFullYear(),A=new Date(v,0,1),B=new Date(v,6,1),D=A.getTimezoneOffset(),X=B.getTimezoneOffset(),_e=Math.max(D,X);F[o>>2]=_e*60,z[l>>2]=+(D!=X);var Te=tt=>{var Pr=tt>=0?"-":"+",Xt=Math.abs(tt),wo=String(Math.floor(Xt/60)).padStart(2,"0"),zr=String(Xt%60).padStart(2,"0");return`UTC${Pr}${wo}${zr}`},Ve=Te(D),je=Te(X);X<D?(Ye(Ve,d,17),Ye(je,g,17)):(Ye(Ve,g,17),Ye(je,d,17))},ro=()=>Date.now(),no=1,io=o=>o>=0&&o<=3;function oo(o,l,d,g){var v=_r(l,d);if(!io(o))return 28;var A;if(o===0)A=ro();else if(no)A=wn();else return 52;var B=Math.round(A*1e3*1e3);return xt=[B>>>0,(Ge=B,+Math.abs(Ge)>=1?Ge>0?+Math.floor(Ge/4294967296)>>>0:~~+Math.ceil((Ge-+(~~Ge>>>0))/4294967296)>>>0:0)],z[g>>2]=xt[0],z[g+4>>2]=xt[1],0}function Ht(o,l){let d=Zt(l.length);P.set(l,d),z[o>>2]=d,z[o+4>>2]=l.length}function vr(o,l){let d=JSON.stringify(l);Ht(o,Er.encode(d))}var _t=function(l,d){return W.handleAsync(async()=>{let g=at(l,d);await _.delete(g)})};_t.isAsync=!0;var xn=function(l,d){return W.handleAsync(async()=>{let g=at(l,d);return _.exists(g)})};xn.isAsync=!0;var kn=function(){return W.handleAsync(async()=>{await _.write(Yt),Yt={}})};kn.isAsync=!0;var Sn=function(l,d,g){return W.handleAsync(async()=>{let v=at(l,d),A=await _.read(v);return A?(Ht(g,A),!0):!1})};Sn.isAsync=!0;function so(o,l,d,g){let v=at(o,l),A=P.subarray(d,d+g);Yt[v]=A}function ao(o){let l=_.get_dirs();vr(o,l)}var An=function(l){return W.handleAsync(async()=>{m||await new Promise(d=>{b=d}),vr(l,m),m=null})};An.isAsync=!0;function wr(o,l){let d=JSON.parse(at(o,l));y.update(d)}function lo(o,l,d){let g=at(o,l),v=_.set_storyfile_dir(g);vr(d,v)}var br=()=>2147483648,fo=(o,l)=>Math.ceil(o/l)*l,uo=o=>{var l=le.buffer,d=(o-l.byteLength+65535)/65536|0;try{return le.grow(d),K(),1}catch{}},co=o=>{var l=ce.length;o>>>=0;var d=br();if(o>d)return!1;for(var g=1;g<=4;g*=2){var v=l*(1+.2/g);v=Math.min(v,o+100663296);var A=Math.min(d,fo(Math.max(o,v),65536)),B=uo(A);if(B)return!0}return!1},Jt={},po=()=>T||"./this.program",mt=()=>{if(!mt.strings){var o=(typeof navigator=="object"&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",l={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:o,_:po()};for(var d in Jt)Jt[d]===void 0?delete l[d]:l[d]=Jt[d];var g=[];for(var d in l)g.push(`${d}=${l[d]}`);mt.strings=g}return mt.strings},ho=(o,l)=>{for(var d=0;d<o.length;++d)P[l++]=o.charCodeAt(d);P[l]=0},_o=(o,l)=>{var d=0;return mt().forEach((g,v)=>{var A=l+d;F[o+v*4>>2]=A,ho(g,A),d+=g.length+1}),0},qt=(o,l)=>{var d=mt();F[o>>2]=d.length;var g=0;return d.forEach(v=>g+=v.length+1),F[l>>2]=g,0},mo=o=>52,go=(o,l,d,g)=>52;function O(o,l,d,g,v){var A=_r(l,d);return 70}var At=[null,[],[]],yo=(o,l=0,d=NaN)=>{for(var g=l+d,v=l;o[v]&&!(v>=g);)++v;return un.decode(o.buffer?o.subarray(l,v):new Uint8Array(o.slice(l,v)))},xr=(o,l)=>{var d=At[o];l===0||l===10?((o===1?ge:oe)(yo(d)),d.length=0):d.push(l)},J=()=>{Fr(0),At[1].length&&xr(1,10),At[2].length&&xr(2,10)},vo=(o,l,d,g)=>{for(var v=0,A=0;A<d;A++){var B=F[l>>2],D=F[l+4>>2];l+=8;for(var X=0;X<D;X++)xr(o,ce[B+X]);v+=D}return F[g>>2]=v,0},kr=o=>o,En=()=>{if(typeof crypto=="object"&&typeof crypto.getRandomValues=="function")return g=>crypto.getRandomValues(g);if(0)try{var o,l,d}catch(g){}Qe("initRandomDevice")},Sr=o=>(Sr=En())(o),Fn=(o,l)=>(Sr(ce.subarray(o,o+l)),0),Ar=o=>Ir(o),Un=o=>{var l=jt(o)+1,d=Ar(l);return Ye(o,d,l),d},ve,Et=o=>{try{return o()}catch(l){Qe(l)}},Cn=()=>{$t+=1},Rn=()=>{$t-=1},W={instrumentWasmImports(o){var l=/^(invoke_.*|__asyncjs__.*)$/;for(let[d,g]of Object.entries(o))if(typeof g=="function"){let v=g.isAsync||l.test(d)}},instrumentWasmExports(o){var l={};for(let[d,g]of Object.entries(o))typeof g=="function"?l[d]=(...v)=>{W.exportCallStack.push(d);try{return g(...v)}finally{if(!pe){var A=W.exportCallStack.pop();W.maybeStopUnwind()}}}:l[d]=g;return l},State:{Normal:0,Unwinding:1,Rewinding:2,Disabled:3},state:0,StackSize:8192,currData:null,handleSleepReturnValue:0,exportCallStack:[],callStackNameToId:{},callStackIdToName:{},callStackId:0,asyncPromiseHandlers:null,sleepCallbacks:[],getCallStackId(o){var l=W.callStackNameToId[o];return l===void 0&&(l=W.callStackId++,W.callStackNameToId[o]=l,W.callStackIdToName[l]=o),l},maybeStopUnwind(){W.currData&&W.state===W.State.Unwinding&&W.exportCallStack.length===0&&(W.state=W.State.Normal,Cn(),Et(c),typeof Fibers<"u"&&Fibers.trampoline())},whenDone(){return new Promise((o,l)=>{W.asyncPromiseHandlers={resolve:o,reject:l}})},allocateData(){var o=Zt(12+W.StackSize);return W.setDataHeader(o,o+12,W.StackSize),W.setDataRewindFunc(o),o},setDataHeader(o,l,d){F[o>>2]=l,F[o+4>>2]=l+d},setDataRewindFunc(o){var l=W.exportCallStack[0],d=W.getCallStackId(l);z[o+8>>2]=d},getDataRewindFuncName(o){var l=z[o+8>>2],d=W.callStackIdToName[l];return d},getDataRewindFunc(o){var l=M[o];return l},doRewind(o){var l=W.getDataRewindFuncName(o),d=W.getDataRewindFunc(l);return Rn(),d()},handleSleep(o){if(!pe){if(W.state===W.State.Normal){var l=!1,d=!1;o((g=0)=>{if(!pe&&(W.handleSleepReturnValue=g,l=!0,!!d)){W.state=W.State.Rewinding,Et(()=>h(W.currData)),typeof MainLoop<"u"&&MainLoop.func&&MainLoop.resume();var v,A=!1;try{v=W.doRewind(W.currData)}catch(X){v=X,A=!0}var B=!1;if(!W.currData){var D=W.asyncPromiseHandlers;D&&(W.asyncPromiseHandlers=null,(A?D.reject:D.resolve)(v),B=!0)}if(A&&!B)throw v}}),d=!0,l||(W.state=W.State.Unwinding,W.currData=W.allocateData(),typeof MainLoop<"u"&&MainLoop.func&&MainLoop.pause(),Et(()=>a(W.currData)))}else W.state===W.State.Rewinding?(W.state=W.State.Normal,Et(w),Cr(W.currData),W.currData=null,W.sleepCallbacks.forEach(vn)):Qe(`invalid state: ${W.state}`);return W.handleSleepReturnValue}},handleAsync(o){return W.handleSleep(l=>{o().then(l)})}};let Yt={},Er=new TextEncoder;var Dn={oa:Ni,l:Qi,r:Vi,a:$i,i:Pi,p:zi,v:Hi,y:Ji,na:qi,I:fn,q:ht,ma:Yi,f:ji,H:Zi,la:pr,ka:hr,ja:cn,da:dn,ca:pn,ba:hn,N:gn,aa:bn,$:to,P:oo,_:_t,Z:xn,Y:kn,X:Sn,W:so,V:ao,U:An,T:wr,S:lo,R:co,ia:_o,ha:qt,Q:yr,G:mo,ga:go,O,D:vo,F:fl,E:ll,t:nl,b:$r,e:Ae,j:tl,s:ol,u:il,w:sl,C:al,B:ul,M:pl,L:_l,K:ml,h:el,c:S,d:H,g:L,n:Ka,k:R,o:Xa,x:rl,z:cl,A:dl,J:hl,m:kr,fa:mr,ea:Fn},M;Li();var Bn=()=>(Bn=M.qa)(),Fr=o=>(Fr=M.ra)(o),Ur=r._main=(o,l)=>(Ur=r._main=M.sa)(o,l),Cr=o=>(Cr=M.ta)(o),Zt=o=>(Zt=M.ua)(o),Rr=()=>(Rr=M.wa)(),Dr=(o,l)=>(Dr=M.xa)(o,l),re=r._setThrew=(o,l)=>(re=r._setThrew=M.ya)(o,l),Br=o=>(Br=M.za)(o),Tr=o=>(Tr=M.Aa)(o),Ir=o=>(Ir=M.Ba)(o),Wr=()=>(Wr=M.Ca)(),Or=o=>(Or=M.Da)(o),Mr=o=>(Mr=M.Ea)(o),Gr=(o,l,d)=>(Gr=M.Fa)(o,l,d),Lr=o=>(Lr=M.Ga)(o),Kt=r.dynCall_vi=(o,l)=>(Kt=r.dynCall_vi=M.Ha)(o,l),Nr=r.dynCall_iii=(o,l,d)=>(Nr=r.dynCall_iii=M.Ia)(o,l,d),Qr=r.dynCall_viiiii=(o,l,d,g,v,A)=>(Qr=r.dynCall_viiiii=M.Ja)(o,l,d,g,v,A),Tn=r.dynCall_viii=(o,l,d,g)=>(Tn=r.dynCall_viii=M.Ka)(o,l,d,g),In=r.dynCall_vii=(o,l,d)=>(In=r.dynCall_vii=M.La)(o,l,d),Wn=r.dynCall_ii=(o,l)=>(Wn=r.dynCall_ii=M.Ma)(o,l),On=r.dynCall_viiii=(o,l,d,g,v)=>(On=r.dynCall_viiii=M.Na)(o,l,d,g,v),Mn=r.dynCall_viiiiii=(o,l,d,g,v,A,B)=>(Mn=r.dynCall_viiiiii=M.Oa)(o,l,d,g,v,A,B),Gn=r.dynCall_v=o=>(Gn=r.dynCall_v=M.Pa)(o),Ln=r.dynCall_iiii=(o,l,d,g)=>(Ln=r.dynCall_iiii=M.Qa)(o,l,d,g),Nn=r.dynCall_iijj=(o,l,d,g,v,A)=>(Nn=r.dynCall_iijj=M.Ra)(o,l,d,g,v,A),Qn=r.dynCall_viiiiiii=(o,l,d,g,v,A,B,D)=>(Qn=r.dynCall_viiiiiii=M.Sa)(o,l,d,g,v,A,B,D),Vn=r.dynCall_i=o=>(Vn=r.dynCall_i=M.Ta)(o),jn=r.dynCall_iiiiii=(o,l,d,g,v,A)=>(jn=r.dynCall_iiiiii=M.Ua)(o,l,d,g,v,A),$n=r.dynCall_iiiii=(o,l,d,g,v)=>($n=r.dynCall_iiiii=M.Va)(o,l,d,g,v),Pn=r.dynCall_iiiiiii=(o,l,d,g,v,A,B)=>(Pn=r.dynCall_iiiiiii=M.Wa)(o,l,d,g,v,A,B),zn=r.dynCall_vijii=(o,l,d,g,v,A)=>(zn=r.dynCall_vijii=M.Xa)(o,l,d,g,v,A),Hn=r.dynCall_iiiiiiii=(o,l,d,g,v,A,B,D)=>(Hn=r.dynCall_iiiiiiii=M.Ya)(o,l,d,g,v,A,B,D),Jn=r.dynCall_j=o=>(Jn=r.dynCall_j=M.Za)(o),qn=r.dynCall_jiiii=(o,l,d,g,v)=>(qn=r.dynCall_jiiii=M._a)(o,l,d,g,v),Yn=r.dynCall_fiii=(o,l,d,g)=>(Yn=r.dynCall_fiii=M.$a)(o,l,d,g),Ft=r.dynCall_diii=(o,l,d,g)=>(Ft=r.dynCall_diii=M.ab)(o,l,d,g),Vr=r.dynCall_iiiiiiiiiiii=(o,l,d,g,v,A,B,D,X,_e,Te,Ve)=>(Vr=r.dynCall_iiiiiiiiiiii=M.bb)(o,l,d,g,v,A,B,D,X,_e,Te,Ve),jr=r.dynCall_viiiiiiiiii=(o,l,d,g,v,A,B,D,X,_e,Te)=>(jr=r.dynCall_viiiiiiiiii=M.cb)(o,l,d,g,v,A,B,D,X,_e,Te),Zn=r.dynCall_viiiiiiiiiiiiiii=(o,l,d,g,v,A,B,D,X,_e,Te,Ve,je,tt,Pr,Xt)=>(Zn=r.dynCall_viiiiiiiiiiiiiii=M.db)(o,l,d,g,v,A,B,D,X,_e,Te,Ve,je,tt,Pr,Xt),a=o=>(a=M.eb)(o),c=()=>(c=M.fb)(),h=o=>(h=M.gb)(o),w=()=>(w=M.hb)();function S(o,l){var d=Y();try{Kt(o,l)}catch(g){if(q(d),g!==g+0)throw g;re(1,0)}}function R(o,l,d,g,v,A){var B=Y();try{Qr(o,l,d,g,v,A)}catch(D){if(q(B),D!==D+0)throw D;re(1,0)}}function L(o,l,d,g){var v=Y();try{Tn(o,l,d,g)}catch(A){if(q(v),A!==A+0)throw A;re(1,0)}}function H(o,l,d){var g=Y();try{In(o,l,d)}catch(v){if(q(g),v!==v+0)throw v;re(1,0)}}function Ae(o,l,d){var g=Y();try{return Nr(o,l,d)}catch(v){if(q(g),v!==v+0)throw v;re(1,0)}}function $r(o,l){var d=Y();try{return Wn(o,l)}catch(g){if(q(d),g!==g+0)throw g;re(1,0)}}function Ka(o,l,d,g,v){var A=Y();try{On(o,l,d,g,v)}catch(B){if(q(A),B!==B+0)throw B;re(1,0)}}function Xa(o,l,d,g,v,A,B){var D=Y();try{Mn(o,l,d,g,v,A,B)}catch(X){if(q(D),X!==X+0)throw X;re(1,0)}}function el(o){var l=Y();try{Gn(o)}catch(d){if(q(l),d!==d+0)throw d;re(1,0)}}function tl(o,l,d,g){var v=Y();try{return Ln(o,l,d,g)}catch(A){if(q(v),A!==A+0)throw A;re(1,0)}}function rl(o,l,d,g,v,A,B,D){var X=Y();try{Qn(o,l,d,g,v,A,B,D)}catch(_e){if(q(X),_e!==_e+0)throw _e;re(1,0)}}function nl(o){var l=Y();try{return Vn(o)}catch(d){if(q(l),d!==d+0)throw d;re(1,0)}}function il(o,l,d,g,v,A){var B=Y();try{return jn(o,l,d,g,v,A)}catch(D){if(q(B),D!==D+0)throw D;re(1,0)}}function ol(o,l,d,g,v){var A=Y();try{return $n(o,l,d,g,v)}catch(B){if(q(A),B!==B+0)throw B;re(1,0)}}function sl(o,l,d,g,v,A,B){var D=Y();try{return Pn(o,l,d,g,v,A,B)}catch(X){if(q(D),X!==X+0)throw X;re(1,0)}}function al(o,l,d,g,v,A,B,D){var X=Y();try{return Hn(o,l,d,g,v,A,B,D)}catch(_e){if(q(X),_e!==_e+0)throw _e;re(1,0)}}function ll(o,l,d,g){var v=Y();try{return Yn(o,l,d,g)}catch(A){if(q(v),A!==A+0)throw A;re(1,0)}}function fl(o,l,d,g){var v=Y();try{return Ft(o,l,d,g)}catch(A){if(q(v),A!==A+0)throw A;re(1,0)}}function ul(o,l,d,g,v,A,B,D,X,_e,Te,Ve){var je=Y();try{return Vr(o,l,d,g,v,A,B,D,X,_e,Te,Ve)}catch(tt){if(q(je),tt!==tt+0)throw tt;re(1,0)}}function cl(o,l,d,g,v,A,B,D,X,_e,Te){var Ve=Y();try{jr(o,l,d,g,v,A,B,D,X,_e,Te)}catch(je){if(q(Ve),je!==je+0)throw je;re(1,0)}}function dl(o,l,d,g,v,A,B,D,X,_e,Te,Ve,je,tt,Pr,Xt){var wo=Y();try{Zn(o,l,d,g,v,A,B,D,X,_e,Te,Ve,je,tt,Pr,Xt)}catch(zr){if(q(wo),zr!==zr+0)throw zr;re(1,0)}}function pl(o,l,d,g,v,A){var B=Y();try{return Nn(o,l,d,g,v,A)}catch(D){if(q(B),D!==D+0)throw D;re(1,0)}}function hl(o,l,d,g,v,A){var B=Y();try{zn(o,l,d,g,v,A)}catch(D){if(q(B),D!==D+0)throw D;re(1,0)}}function _l(o){var l=Y();try{return Jn(o)}catch(d){if(q(l),d!==d+0)throw d;re(1,0)}}function ml(o,l,d,g,v){var A=Y();try{return qn(o,l,d,g,v)}catch(B){if(q(A),B!==B+0)throw B;re(1,0)}}var Kn;He=function o(){Kn||ms(),Kn||(He=o)};function _s(o=[]){var l=Ur;o.unshift(T);var d=o.length,g=Ar((d+1)*4),v=g;o.forEach(B=>{F[v>>2]=Un(B),v+=4}),F[v>>2]=0;try{var A=l(d,g);return gr(A,!0),A}catch(B){return Pt(B)}}function ms(o=E){if(ze>0||(De(),ze>0))return;function l(){Kn||(Kn=!0,r.calledRun=!0,!pe&&(Lt(),Nt(),i(r),gl&&_s(o),Ui()))}l()}var gl=!1;return ms(),t=u,t}})(),Ha=_c;var hs={},mc=(()=>{var n=hs.url;return async function(e={}){var t,r=e,i,s,u=new Promise((a,c)=>{i=a,s=c}),f=typeof WorkerGlobalScope<"u";if(0)var p;let _,y,m,b=()=>{};r.start=function(a){if(_=a.Dialog,!_.async)throw new Error("Emglken requires an async Dialog library");y=a.GlkOte,a.accept=x,Vr(a.arguments),y.init(a)};function x(a){m&&console.warn("Already have GlkOte event when next event arrives"),m=a,b()}r.locateFile=function(a){try{return new URL(a,hs.url).href}catch{return a}};var U=Object.assign({},r),E=[],T="./this.program",I=(a,c)=>{throw c},j="";function ne(a){return r.locateFile?r.locateFile(a,j):j+a}var ke,me;if(0)var ee,ie;else f?j=self.location.href:typeof document<"u"&&document.currentScript&&(j=document.currentScript.src),n&&(j=n),j.startsWith("blob:")?j="":j=j.substr(0,j.replace(/[?#].*/,"").lastIndexOf("/")+1),ke=async a=>{var c=await fetch(a,{credentials:"same-origin"});if(c.ok)return c.arrayBuffer();throw new Error(c.status+" : "+c.url)};var ge=console.log.bind(console),oe=console.error.bind(console);Object.assign(r,U),U=null;var be=r.wasmBinary,le,pe=!1,he,P,ce,se,ue,z,F,C,Z;function K(){var a=le.buffer;P=new Int8Array(a),se=new Int16Array(a),ce=new Uint8Array(a),ue=new Uint16Array(a),z=new Int32Array(a),F=new Uint32Array(a),C=new Float32Array(a),Z=new Float64Array(a)}var de=[],Ee=[],Me=[],dt=[],Se=[],Ce=!1,Re=!1;function De(){Je(de)}function Lt(){Ce=!0,Je(Ee)}function Nt(){Je(Me)}function Qt(){Fn(),Je(dt),fo(),Re=!0}function Ui(){Je(Se)}function Ci(a){Ee.unshift(a)}var ze=0,He=null;function Ri(a){ze++}function Di(a){if(ze--,ze==0&&He){var c=He;He=null,c()}}function Qe(a){a="Aborted("+a+")",oe(a),pe=!0,a+=". Build with -sASSERTIONS for more info.";var c=new WebAssembly.RuntimeError(a);throw s(c),c}var Bi="data:application/octet-stream;base64,",fr=a=>a.startsWith(Bi),Za=a=>a.startsWith("file://");function Ti(){if(r.locateFile){var a="glulxe.wasm";return fr(a)?a:ne(a)}return new URL("glulxe.wasm",hs.url).href}var bt;function Ii(a){if(a==bt&&be)return new Uint8Array(be);if(me)return me(a);throw"both async and sync fetching of the wasm failed"}async function Wi(a){if(!be)try{var c=await ke(a);return new Uint8Array(c)}catch{}return Ii(a)}async function Oi(a,c){try{var h=await Wi(a),w=await WebAssembly.instantiate(h,c);return w}catch(S){oe(`failed to asynchronously prepare wasm: ${S}`),Qe(S)}}async function Mi(a,c,h){if(!a&&typeof WebAssembly.instantiateStreaming=="function"&&!fr(c)&&typeof fetch=="function")try{var w=fetch(c,{credentials:"same-origin"}),S=await WebAssembly.instantiateStreaming(w,h);return S}catch(R){oe(`wasm streaming compile failed: ${R}`),oe("falling back to ArrayBuffer instantiation")}return Oi(c,h)}function Gi(){return{a:xr}}async function Li(){function a(S,R){return J=S.exports,J=O.instrumentWasmExports(J),le=J._,K(),_o=J.da,Ci(J.$),Di("wasm-instantiate"),J}Ri("wasm-instantiate");function c(S){a(S.instance)}var h=Gi();bt??=Ti();try{var w=await Mi(be,bt,h);return c(w),w}catch(S){s(S);return}}var Ge,xt;class ur{name="ExitStatus";constructor(c){this.message=`Program terminated with exit(${c})`,this.status=c}}var Je=a=>{for(;a.length>0;)a.shift()(r)},q=a=>Cn(a),Y=()=>W(),Ni=(a,c)=>(h=>Er(a,h))(c),qe=0;class kt{constructor(c){this.excPtr=c,this.ptr=c-24}set_type(c){F[this.ptr+4>>2]=c}get_type(){return F[this.ptr+4>>2]}set_destructor(c){F[this.ptr+8>>2]=c}get_destructor(){return F[this.ptr+8>>2]}set_caught(c){c=c?1:0,P[this.ptr+12]=c}get_caught(){return P[this.ptr+12]!=0}set_rethrown(c){c=c?1:0,P[this.ptr+13]=c}get_rethrown(){return P[this.ptr+13]!=0}init(c,h){this.set_adjusted_ptr(0),this.set_type(c),this.set_destructor(h)}set_adjusted_ptr(c){F[this.ptr+16>>2]=c}get_adjusted_ptr(){return F[this.ptr+16>>2]}}var Qi=a=>{throw qe||(qe=a),qe},Be=a=>Et(a),Vi=a=>{var c=qe;if(!c)return Be(0),0;var h=new kt(c);h.set_adjusted_ptr(c);var w=h.get_type();if(!w)return Be(0),c;for(var S of a){if(S===0||S===w)break;var R=h.ptr+16;if(Yt(S,w,R))return Be(S),c}return Be(w),c},cr=()=>Vi([]),ji=0,Vt=(a,c,h)=>{var w=new kt(a);throw w.init(c,h),qe=a,ji++,qe},pt=(a,c)=>{},$i=a=>{for(var c=0,h=0;h<a.length;++h){var w=a.charCodeAt(h);w<=127?c++:w<=2047?c+=2:w>=55296&&w<=57343?(c+=4,++h):c+=3}return c},Pi=(a,c,h,w)=>{if(!(w>0))return 0;for(var S=h,R=h+w-1,L=0;L<a.length;++L){var H=a.charCodeAt(L);if(H>=55296&&H<=57343){var Ae=a.charCodeAt(++L);H=65536+((H&1023)<<10)|Ae&1023}if(H<=127){if(h>=R)break;c[h++]=H}else if(H<=2047){if(h+1>=R)break;c[h++]=192|H>>6,c[h++]=128|H&63}else if(H<=65535){if(h+2>=R)break;c[h++]=224|H>>12,c[h++]=128|H>>6&63,c[h++]=128|H&63}else{if(h+3>=R)break;c[h++]=240|H>>18,c[h++]=128|H>>12&63,c[h++]=128|H>>6&63,c[h++]=128|H&63}}return c[h]=0,h-S},zi=(a,c,h)=>Pi(a,ce,c,h),Hi=(a,c)=>{},Ji=(a,c)=>{},qi=(a,c,h,w)=>{},fn=new TextDecoder,ht=(a,c)=>{if(!a)return"";for(var h=a+c,w=a;!(w>=h)&&ce[w];)++w;return fn.decode(ce.subarray(a,w))},Yi={varargs:void 0,getStr(a){var c=ht(a);return c}};function un(a,c,h,w){Yi.varargs=w}var at=(a,c)=>{},dr=()=>Qe(""),Zi=(a,c,h)=>ce.copyWithin(a,c,c+h),jt=0,Ki=()=>{jt=0},Ye={},pr=a=>{if(a instanceof ur||a=="unwind")return he;I(1,a)},hr=()=>jt>0,cn=a=>{he=a,hr()||(pe=!0),I(a,new ur(a))},dn=(a,c)=>{he=a,hr()||Qt(),cn(a)},pn=dn,$t=()=>{if(!Re&&!hr())try{pn(he)}catch(a){pr(a)}},hn=a=>{if(!(Re||pe))try{a(),$t()}catch(c){pr(c)}},_n=()=>performance.now(),Xi=(a,c)=>{if(Ye[a]&&(clearTimeout(Ye[a].id),delete Ye[a]),!c)return 0;var h=setTimeout(()=>{delete Ye[a],hn(()=>Un(a,_n()))},c);return Ye[a]={id:h,timeout_ms:c},0},mn=()=>Date.now(),eo=1,_r=a=>a>=0&&a<=3,gn=(a,c)=>c+2097152>>>0<4194305-!!a?(a>>>0)+c*4294967296:NaN;function St(a,c,h,w){var S=gn(c,h);if(!_r(a))return 28;var R;if(a===0)R=mn();else if(eo)R=_n();else return 52;var L=Math.round(R*1e3*1e3);return xt=[L>>>0,(Ge=L,+Math.abs(Ge)>=1?Ge>0?+Math.floor(Ge/4294967296)>>>0:~~+Math.ceil((Ge-+(~~Ge>>>0))/4294967296)>>>0:0)],z[w>>2]=xt[0],z[w+4>>2]=xt[1],0}function Pt(a,c){let h=kr(c.length);P.set(c,h),z[a>>2]=h,z[a+4>>2]=c.length}function zt(a,c){let h=JSON.stringify(c);Pt(a,yo.encode(h))}var mr=function(c,h){return O.handleAsync(async()=>{let w=ht(c,h);await _.delete(w)})};mr.isAsync=!0;var gr=function(c,h){return O.handleAsync(async()=>{let w=ht(c,h);return _.exists(w)})};gr.isAsync=!0;var yr=function(){return O.handleAsync(async()=>{await _.write(At),At={}})};yr.isAsync=!0;var yn=function(c,h,w){return O.handleAsync(async()=>{let S=ht(c,h),R=await _.read(S);return R?(Pt(w,R),!0):!1})};yn.isAsync=!0;function vn(a,c,h,w){let S=ht(a,c),R=P.subarray(h,h+w);At[S]=R}function wn(a){let c=_.get_dirs();zt(a,c)}var bn=function(c){return O.handleAsync(async()=>{m||await new Promise(h=>{b=h}),zt(c,m),m=null})};bn.isAsync=!0;function to(a,c){let h=JSON.parse(ht(a,c));y.update(h)}var ro=()=>2147483648,no=(a,c)=>Math.ceil(a/c)*c,io=a=>{var c=le.buffer,h=(a-c.byteLength+65535)/65536|0;try{return le.grow(h),K(),1}catch{}},oo=a=>{var c=ce.length;a>>>=0;var h=ro();if(a>h)return!1;for(var w=1;w<=4;w*=2){var S=c*(1+.2/w);S=Math.min(S,a+100663296);var R=Math.min(h,no(Math.max(a,S),65536)),L=io(R);if(L)return!0}return!1},Ht={},vr=()=>T||"./this.program",_t=()=>{if(!_t.strings){var a=(typeof navigator=="object"&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",c={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:a,_:vr()};for(var h in Ht)Ht[h]===void 0?delete c[h]:c[h]=Ht[h];var w=[];for(var h in c)w.push(`${h}=${c[h]}`);_t.strings=w}return _t.strings},xn=(a,c)=>{for(var h=0;h<a.length;++h)P[c++]=a.charCodeAt(h);P[c]=0},kn=(a,c)=>{var h=0;return _t().forEach((w,S)=>{var R=c+h;F[a+S*4>>2]=R,xn(w,R),h+=w.length+1}),0},Sn=(a,c)=>{var h=_t();F[a>>2]=h.length;var w=0;return h.forEach(S=>w+=S.length+1),F[c>>2]=w,0},so=a=>52,ao=(a,c,h,w)=>52;function An(a,c,h,w,S){var R=gn(c,h);return 70}var wr=[null,[],[]],lo=(a,c=0,h=NaN)=>{for(var w=c+h,S=c;a[S]&&!(S>=w);)++S;return fn.decode(a.buffer?a.subarray(c,S):new Uint8Array(a.slice(c,S)))},br=(a,c)=>{var h=wr[a];c===0||c===10?((a===1?ge:oe)(lo(h)),h.length=0):h.push(c)},fo=()=>{Ar(0),wr[1].length&&br(1,10),wr[2].length&&br(2,10)},uo=(a,c,h,w)=>{for(var S=0,R=0;R<h;R++){var L=F[c>>2],H=F[c+4>>2];c+=8;for(var Ae=0;Ae<H;Ae++)br(a,ce[L+Ae]);S+=H}return F[w>>2]=S,0},co=()=>{if(typeof crypto=="object"&&typeof crypto.getRandomValues=="function")return w=>crypto.getRandomValues(w);if(0)try{var a,c,h}catch(w){}Qe("initRandomDevice")},Jt=a=>(Jt=co())(a),po=(a,c)=>(Jt(ce.subarray(a,a+c)),0),mt=a=>Rn(a),ho=a=>{var c=$i(a)+1,h=mt(c);return zi(a,h,c),h},_o,qt=a=>{try{return a()}catch(c){Qe(c)}},mo=()=>{jt+=1},go=()=>{jt-=1},O={instrumentWasmImports(a){var c=/^(invoke_.*|__asyncjs__.*)$/;for(let[h,w]of Object.entries(a))if(typeof w=="function"){let S=w.isAsync||c.test(h)}},instrumentWasmExports(a){var c={};for(let[h,w]of Object.entries(a))typeof w=="function"?c[h]=(...S)=>{O.exportCallStack.push(h);try{return w(...S)}finally{if(!pe){var R=O.exportCallStack.pop();O.maybeStopUnwind()}}}:c[h]=w;return c},State:{Normal:0,Unwinding:1,Rewinding:2,Disabled:3},state:0,StackSize:8192,currData:null,handleSleepReturnValue:0,exportCallStack:[],callStackNameToId:{},callStackIdToName:{},callStackId:0,asyncPromiseHandlers:null,sleepCallbacks:[],getCallStackId(a){var c=O.callStackNameToId[a];return c===void 0&&(c=O.callStackId++,O.callStackNameToId[a]=c,O.callStackIdToName[c]=a),c},maybeStopUnwind(){O.currData&&O.state===O.State.Unwinding&&O.exportCallStack.length===0&&(O.state=O.State.Normal,mo(),qt(Kt),typeof Fibers<"u"&&Fibers.trampoline())},whenDone(){return new Promise((a,c)=>{O.asyncPromiseHandlers={resolve:a,reject:c}})},allocateData(){var a=kr(12+O.StackSize);return O.setDataHeader(a,a+12,O.StackSize),O.setDataRewindFunc(a),a},setDataHeader(a,c,h){F[a>>2]=c,F[a+4>>2]=c+h},setDataRewindFunc(a){var c=O.exportCallStack[0],h=O.getCallStackId(c);z[a+8>>2]=h},getDataRewindFuncName(a){var c=z[a+8>>2],h=O.callStackIdToName[c];return h},getDataRewindFunc(a){var c=J[a];return c},doRewind(a){var c=O.getDataRewindFuncName(a),h=O.getDataRewindFunc(c);return go(),h()},handleSleep(a){if(!pe){if(O.state===O.State.Normal){var c=!1,h=!1;a((w=0)=>{if(!pe&&(O.handleSleepReturnValue=w,c=!0,!!h)){O.state=O.State.Rewinding,qt(()=>Nr(O.currData)),typeof MainLoop<"u"&&MainLoop.func&&MainLoop.resume();var S,R=!1;try{S=O.doRewind(O.currData)}catch(Ae){S=Ae,R=!0}var L=!1;if(!O.currData){var H=O.asyncPromiseHandlers;H&&(O.asyncPromiseHandlers=null,(R?H.reject:H.resolve)(S),L=!0)}if(R&&!L)throw S}}),h=!0,c||(O.state=O.State.Unwinding,O.currData=O.allocateData(),typeof MainLoop<"u"&&MainLoop.func&&MainLoop.pause(),qt(()=>Lr(O.currData)))}else O.state===O.State.Rewinding?(O.state=O.State.Normal,qt(Qr),En(O.currData),O.currData=null,O.sleepCallbacks.forEach(hn)):Qe(`invalid state: ${O.state}`);return O.handleSleepReturnValue}},handleAsync(a){return O.handleSleep(c=>{a().then(c)})}};let At={},yo=new TextEncoder;var xr={Z:Ni,a:cr,Y:Vt,g:Qi,X:pt,W:Hi,V:Ji,U:qi,T:un,S:at,K:dr,J:Zi,I:Ki,H:Xi,u:St,G:mr,F:gr,E:yr,D:yn,C:vn,B:wn,A:bn,z:to,y:mn,x:oo,R:kn,Q:Sn,w:pn,P:so,O:ao,t:An,N:uo,m:$n,c:Gn,k:Mn,i:Vn,o:zn,l:Pn,p:Hn,s:Jn,r:Yn,h:Qn,b:Tn,d:On,f:Wn,j:Ln,e:In,n:Nn,v:jn,q:qn,M:cn,L:po},J;Li();var vo=()=>(vo=J.$)(),kr=a=>(kr=J.aa)(a),En=a=>(En=J.ba)(a),Sr=r._main=(a,c)=>(Sr=r._main=J.ca)(a,c),Fn=()=>(Fn=J.ea)(),Ar=a=>(Ar=J.fa)(a),Un=(a,c)=>(Un=J.ga)(a,c),ve=r._setThrew=(a,c)=>(ve=r._setThrew=J.ha)(a,c),Et=a=>(Et=J.ia)(a),Cn=a=>(Cn=J.ja)(a),Rn=a=>(Rn=J.ka)(a),W=()=>(W=J.la)(),Yt=(a,c,h)=>(Yt=J.ma)(a,c,h),Er=r.dynCall_vi=(a,c)=>(Er=r.dynCall_vi=J.na)(a,c),Dn=r.dynCall_iii=(a,c,h)=>(Dn=r.dynCall_iii=J.oa)(a,c,h),M=r.dynCall_viiiii=(a,c,h,w,S,R)=>(M=r.dynCall_viiiii=J.pa)(a,c,h,w,S,R),Bn=r.dynCall_viii=(a,c,h,w)=>(Bn=r.dynCall_viii=J.qa)(a,c,h,w),Fr=r.dynCall_vii=(a,c,h)=>(Fr=r.dynCall_vii=J.ra)(a,c,h),Ur=r.dynCall_ii=(a,c)=>(Ur=r.dynCall_ii=J.sa)(a,c),Cr=r.dynCall_viiii=(a,c,h,w,S)=>(Cr=r.dynCall_viiii=J.ta)(a,c,h,w,S),Zt=r.dynCall_viiiiii=(a,c,h,w,S,R,L)=>(Zt=r.dynCall_viiiiii=J.ua)(a,c,h,w,S,R,L),Rr=r.dynCall_v=a=>(Rr=r.dynCall_v=J.va)(a),Dr=r.dynCall_iiii=(a,c,h,w)=>(Dr=r.dynCall_iiii=J.wa)(a,c,h,w),re=r.dynCall_iijj=(a,c,h,w,S,R)=>(re=r.dynCall_iijj=J.xa)(a,c,h,w,S,R),Br=r.dynCall_viiiiiii=(a,c,h,w,S,R,L,H)=>(Br=r.dynCall_viiiiiii=J.ya)(a,c,h,w,S,R,L,H),Tr=r.dynCall_i=a=>(Tr=r.dynCall_i=J.za)(a),Ir=r.dynCall_iiiiii=(a,c,h,w,S,R)=>(Ir=r.dynCall_iiiiii=J.Aa)(a,c,h,w,S,R),Wr=r.dynCall_iiiii=(a,c,h,w,S)=>(Wr=r.dynCall_iiiii=J.Ba)(a,c,h,w,S),Or=r.dynCall_viij=(a,c,h,w,S)=>(Or=r.dynCall_viij=J.Ca)(a,c,h,w,S),Mr=r.dynCall_jiij=(a,c,h,w,S)=>(Mr=r.dynCall_jiij=J.Da)(a,c,h,w,S),Gr=r.dynCall_iiiiiii=(a,c,h,w,S,R,L)=>(Gr=r.dynCall_iiiiiii=J.Ea)(a,c,h,w,S,R,L),Lr=a=>(Lr=J.Fa)(a),Kt=()=>(Kt=J.Ga)(),Nr=a=>(Nr=J.Ha)(a),Qr=()=>(Qr=J.Ia)();function Tn(a,c){var h=Y();try{Er(a,c)}catch(w){if(q(h),w!==w+0)throw w;ve(1,0)}}function In(a,c,h,w,S,R){var L=Y();try{M(a,c,h,w,S,R)}catch(H){if(q(L),H!==H+0)throw H;ve(1,0)}}function Wn(a,c,h,w){var S=Y();try{Bn(a,c,h,w)}catch(R){if(q(S),R!==R+0)throw R;ve(1,0)}}function On(a,c,h){var w=Y();try{Fr(a,c,h)}catch(S){if(q(w),S!==S+0)throw S;ve(1,0)}}function Mn(a,c,h){var w=Y();try{return Dn(a,c,h)}catch(S){if(q(w),S!==S+0)throw S;ve(1,0)}}function Gn(a,c){var h=Y();try{return Ur(a,c)}catch(w){if(q(h),w!==w+0)throw w;ve(1,0)}}function Ln(a,c,h,w,S){var R=Y();try{Cr(a,c,h,w,S)}catch(L){if(q(R),L!==L+0)throw L;ve(1,0)}}function Nn(a,c,h,w,S,R,L){var H=Y();try{Zt(a,c,h,w,S,R,L)}catch(Ae){if(q(H),Ae!==Ae+0)throw Ae;ve(1,0)}}function Qn(a){var c=Y();try{Rr(a)}catch(h){if(q(c),h!==h+0)throw h;ve(1,0)}}function Vn(a,c,h,w){var S=Y();try{return Dr(a,c,h,w)}catch(R){if(q(S),R!==R+0)throw R;ve(1,0)}}function jn(a,c,h,w,S,R,L,H){var Ae=Y();try{Br(a,c,h,w,S,R,L,H)}catch($r){if(q(Ae),$r!==$r+0)throw $r;ve(1,0)}}function $n(a){var c=Y();try{return Tr(a)}catch(h){if(q(c),h!==h+0)throw h;ve(1,0)}}function Pn(a,c,h,w,S,R){var L=Y();try{return Ir(a,c,h,w,S,R)}catch(H){if(q(L),H!==H+0)throw H;ve(1,0)}}function zn(a,c,h,w,S){var R=Y();try{return Wr(a,c,h,w,S)}catch(L){if(q(R),L!==L+0)throw L;ve(1,0)}}function Hn(a,c,h,w,S,R,L){var H=Y();try{return Gr(a,c,h,w,S,R,L)}catch(Ae){if(q(H),Ae!==Ae+0)throw Ae;ve(1,0)}}function Jn(a,c,h,w,S,R){var L=Y();try{return re(a,c,h,w,S,R)}catch(H){if(q(L),H!==H+0)throw H;ve(1,0)}}function qn(a,c,h,w,S){var R=Y();try{Or(a,c,h,w,S)}catch(L){if(q(R),L!==L+0)throw L;ve(1,0)}}function Yn(a,c,h,w,S){var R=Y();try{return Mr(a,c,h,w,S)}catch(L){if(q(R),L!==L+0)throw L;ve(1,0)}}var Ft;He=function a(){Ft||jr(),Ft||(He=a)};function Vr(a=[]){var c=Sr;a.unshift(T);var h=a.length,w=mt((h+1)*4),S=w;a.forEach(L=>{F[S>>2]=ho(L),S+=4}),F[S>>2]=0;try{var R=c(h,w);return dn(R,!0),R}catch(L){return pr(L)}}function jr(a=E){if(ze>0||(De(),ze>0))return;function c(){Ft||(Ft=!0,r.calledRun=!0,!pe&&(Lt(),Nt(),i(r),Zn&&Vr(a),Ui()))}c()}var Zn=!1;return jr(),t=u,t}})(),Ja=mc;var gc={};function qa(){return{auto_launch:1,autoplay:window.self===window.top,Dialog:new tn,direct_domains:["ifarchive.org","mirror.ifarchive.org","unbox.ifarchive.org","www.ifarchive.org"],do_vm_autosave:1,GlkOte:new lr,lib_path:gc.url,proxy_url:"https://iplayif.com/proxy/",set_body_to_page_bg:1,theme_cookie:"parchment_theme",use_proxy:1}}function Ya(n){let e=new URLSearchParams(document.location.search),t={};for(let r of n)if(e.has(r)){let i=e.get(r);try{t[r]=JSON.parse(i)}catch{t[r]=i}}return t}async function yc(){let n=Object.assign({},qa(),window.parchment_options,Ya(["do_vm_autosave"]));if(!n.default_story)return n.GlkOte.error("No storyfile specified");await n.Dialog.init(this.options);let e=n.default_story[0],t;if(/\.(zblorb|zlb|z3|z4|z5|z8)(\.js)?$/.test(e))t="zcode";else if(/\.(gblorb|glb|ulx)(\.js)?$/.test(e))t="glulx";else return n.GlkOte.error("Unknown storyfile format");$.ajaxSetup({cache:!0,crossDomain:!0});let r=t==="zcode"?Ha:Ja,i=t==="zcode"?"bocfel.js":"glulxe.js",s;try{s=await $.ajax({dataType:"jsonp",jsonp:!1,jsonpCallback:"processBase64Zcode",url:n.lib_path+i})}catch(f){return n.GlkOte.error(`Error loading engine: ${f.status}`)}let u;try{u=await $.ajax({dataType:"jsonp",jsonp:!1,jsonpCallback:"processBase64Zcode",url:e})}catch(f){return n.GlkOte.error(`Error loading storyfile: ${f.status}`)}try{let f=await rt(u),p=new Ie(f);p.getFourCC(0)==="FORM"&&p.getFourCC(8)==="IFRS"&&(n.Blorb=new Zr(f));let _=n.story_name.substring(0,n.story_name.length-3);n.arguments=[await n.Dialog.upload(new File([f],_))];let y=await rt(s),m=tr(y);(await r({wasmBinary:m})).start(n)}catch(f){n.GlkOte.error(f)}}$(yc);})();
/*! Bundled license information:

lodash-es/lodash.js:
  (**
   * @license
   * Lodash (Custom Build) <https://lodash.com/>
   * Build: `lodash modularize exports="es" -o ./`
   * Copyright OpenJS Foundation and other contributors <https://openjsf.org/>
   * Released under MIT license <https://lodash.com/license>
   * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
   * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
   *)
*/
